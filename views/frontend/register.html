<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reg√≠strate - Men√∫ Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Toastr & jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="./assets/css/front.css">
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Outfit', 'sans-serif'] }, 
                    colors: { brand: '#6366f1', brandDark: '#4f46e5' } 
                } 
            } 
        }
        // Configuraci√≥n Toastr (Formateada para evitar errores de l√≠nea)
        toastr.options = {
            "positionClass": "toast-top-center",
            "timeOut": "3000",
            "showDuration": "300",
            "hideDuration": "1000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
    </script>
    <style>
        .category-card { transition: all 0.2s ease; user-select: none; }
        .category-selected { background-color: #e0e7ff; border-color: #6366f1; color: #4338ca; ring-width: 2px; ring-color: #6366f1; }
        /* Ocultar scrollbar en contenedor de categor√≠as si es necesario */
        .thin-scroll::-webkit-scrollbar { width: 4px; }
        .thin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-4" style="background-image: url('../assets/images/background.jpg');background-position: center center;background-repeat: repeat-x;background-size: contain;">
    <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-lg border border-slate-100">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-black text-slate-900">Crea tu cuenta</h1>
            <p class="text-slate-500 text-sm">Configura tu negocio en minutos.</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <!-- Datos B√°sicos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nombre del Negocio</label>
                    <input type="text" name="businessName" required class="w-full p-3 rounded-xl border border-slate-200 focus:border-brand outline-none bg-slate-50 focus:bg-white transition" placeholder="Ej. Tacos El Paisa">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tu Nombre</label>
                    <input type="text" name="name" required class="w-full p-3 rounded-xl border border-slate-200 focus:border-brand outline-none bg-slate-50 focus:bg-white transition" placeholder="Nombre completo">
                </div>
            </div>

            <!-- SELECTOR DE CATEGOR√çAS (UI MEJORADA) -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">¬øQu√© vendes? (Selecciona varios)</label>
                <div id="categories-container" class="grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-48 overflow-y-auto thin-scroll p-1">
                    <!-- Se llenar√° con JS -->
                </div>
                <p id="cat-error" class="text-red-500 text-xs mt-1 hidden">Selecciona al menos una categor√≠a.</p>
            </div>

            <!-- Credenciales -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Correo Electr√≥nico</label>
                <input type="email" name="email" required class="w-full p-3 rounded-xl border border-slate-200 focus:border-brand outline-none bg-slate-50 focus:bg-white transition" placeholder="correo@ejemplo.com">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Contrase√±a</label>
                <input type="password" name="password" required class="w-full p-3 rounded-xl border border-slate-200 focus:border-brand outline-none bg-slate-50 focus:bg-white transition" placeholder="********">
            </div>

            <button type="submit" id="btn-submit" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg hover:bg-slate-800 transition transform active:scale-95">
                Registrarse
            </button>
        </form>
        
        <p class="text-center text-xs text-slate-400 mt-6">
            ¬øYa tienes cuenta? <a href="/admin" class="text-brand font-bold hover:underline">Inicia Sesi√≥n</a>
        </p>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN DE CATEGOR√çAS ---
        // --- 1. CONFIGURACI√ìN DE CATEGOR√çAS (DIN√ÅMICAS) ---
        const selectedCategories = new Set(); // Usamos Set para evitar duplicados
        const container = document.getElementById('categories-container');

        const loadCategories = async () => {
            try {
                const res = await fetch('/api/public/categories-store');
                if(!res.ok) throw new Error("Error cargando categor√≠as");
                
                const availableCategories = await res.json();
                
                // Limpiar loader si existiera (aqu√≠ estaba vac√≠o al inicio)
                container.innerHTML = ''; 

                if(availableCategories.length === 0) {
                    container.innerHTML = '<p class="col-span-4 text-center text-xs text-slate-400">No hay categor√≠as disponibles</p>';
                    return;
                }

                availableCategories.forEach(cat => {
                    // Verificamos propiedad active
                    if(cat.active === false) return;

                    const btn = document.createElement('div');
                    btn.className = `category-card cursor-pointer border border-slate-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 text-center hover:bg-slate-50 transition bg-white`;
                    // Usamos _id de mongo como clave
                    btn.innerHTML = `
                        <span class="text-xl">${cat.emoji || 'üçΩÔ∏è'}</span>
                        <span class="text-[10px] font-bold leading-tight uppercase text-slate-600">${cat.name}</span>
                    `;
                    btn.onclick = () => toggleCategory(cat._id, btn, cat.name); // Pasamos ID real
                    container.appendChild(btn);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="col-span-4 text-center text-xs text-red-400">Error al cargar categor√≠as</p>';
            }
        };

        function toggleCategory(id, element, name) {
            // Guardamos el objeto simplificado o el ID. 
            // IMPORTANTE: El backend espera un array de objetos con { type: String } O strings directos dependiendo del modelo.
            // Revisando modelo Business.js: categories: [{ type: String, required: true }]
            // PERO en el formulario anterior enviaban IDs como strings ("burgers").
            // Si queremos guardar el NOMBRE de la categor√≠a global como referencia, usamos cat.name o un slug. Iremos con el NOMBRE para consistencia visual si no tenemos slugs globales.
            // OJO: El modelo `Business.js` define categories como `[{ type: String }]`. Antes era un Enum. Ahora es libre.
            // enviaremos el NOMBRE para que sea legible, o podemos enviar el ID si queremos relaci√≥n estricta. 
            // PERO, la app usa nombres para mostrar filtros. Usemos el NOMBRE (slugify si fuera necesario, pero el user pide "Nombre").
            
            // CORRECCI√ìN: Si usamos el sistema de categor√≠as globales, idealmente guardar√≠amos IDs. pero el frontend legacy usa strings.
            // Vamos a guardar el NOMBRE TAL CUAL viene de la store.
            
            const val = name; // Usaremos el nombre como identificador por compatibilidad con el front actual que espera strings.

            if (selectedCategories.has(val)) {
                selectedCategories.delete(val);
                element.classList.remove('category-selected', 'ring-2', 'ring-brand', 'bg-indigo-50');
                element.classList.add('bg-white');
            } else {
                selectedCategories.add(val);
                element.classList.add('category-selected', 'ring-2', 'ring-brand', 'bg-indigo-50');
                element.classList.remove('bg-white');
            }
            // Ocultar error si ya seleccion√≥ algo
            if(selectedCategories.size > 0) document.getElementById('cat-error').classList.add('hidden');
        }

        // Iniciar carga
        loadCategories();

        // --- 2. L√ìGICA DE REGISTRO ---

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validaci√≥n manual de categor√≠as
            if (selectedCategories.size === 0) {
                document.getElementById('cat-error').classList.remove('hidden');
                return;
            }

            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Procesando...";

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // AGREGAR LAS CATEGOR√çAS AL PAYLOAD
            data.categories = Array.from(selectedCategories);

            try {
                // Registrar
                const res = await fetch('/api/public/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (!res.ok) throw new Error(result.message || 'Error en registro');

                localStorage.setItem('token', result.token);
                toastr.success("Registro completo, Bienvenido!!");
                window.location = '/admin';
            } catch (error) {
                toastr.error(error.message);
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });
    </script>
</body>
</html>