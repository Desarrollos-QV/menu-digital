<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Menu Digital</title>    
    <link rel="icon" type="image/x-icon" href="../assets/images/icon.png"/>
    <link rel="icon" href="../assets/images/icon.png" type="image/png" sizes="16x16">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> -->
    <!-- Vue 3 (ESM Browser build para módulos) -->
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
          }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- JQUERY (Requerido para Toastr) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- TOASTR (Notificaciones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SWEETALERT2 (Alertas Modales) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- DATATABLES CSS/JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    <style>
        @media print {
            body * { visibility: hidden; }
            #ticket-print-area, #ticket-print-area * { visibility: visible; }
            #ticket-print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css">
    <!-- HTML5-QRCODE -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .category-card { transition: all 0.2s ease; user-select: none; }
        .category-selected { background-color: #e0e7ff; border-color: #6366f1; color: #4338ca; ring-width: 2px; ring-color: #6366f1; }
        /* Ocultar scrollbar en contenedor de categorías si es necesario */
        .thin-scroll::-webkit-scrollbar { width: 4px; }
        .thin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
<div id="app" class="h-screen flex flex-col text-slate-800 dark:text-slate-100" v-cloak>

    <!-- LOGIN SCREEN (Simulado) -->
    <div v-if="!isAuthenticated" class="flex-1 flex items-center justify-center bg-slate-900 bg-opacity-95" style="background-image: url('../assets/images/background.jpg');background-position: center center;background-repeat: repeat-x;background-size: contain;">
        <div class="bg-white dark:bg-slate-800 p-10 rounded-2xl shadow-2xl w-full max-w-md transform transition-all hover:scale-105 duration-300 border dark:border-slate-700">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl shadow-lg">
                    <img src="../assets/images/logo.jpg" alt="logo" class="rounded-full">
                </div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-white">Bienvenido(a)</h2>
                <p class="text-slate-500 dark:text-slate-400 mt-2">Panel de Control de Tengo Hambre</p>
            </div>
            <form @submit.prevent="login">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Usuario</label>
                        <input v-model="credentials.username" type="text" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition dark:text-white" placeholder="admin">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Contraseña</label>
                        <input v-model="credentials.password" type="password" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition dark:text-white" placeholder="******">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 transform active:scale-95">
                        Iniciar Sesión
                    </button>
                </div>
                <p v-if="loginError" class="text-red-500 text-sm mt-4 text-center bg-red-50 dark:bg-red-900/20 py-2 rounded">{{
                    loginError }}
                </p>
            </form>
            <p class="text-center text-slate-500 text-sm mt-6">
                ¿Aún no tienes cuenta? <a href="/register" class="text-indigo-400 hover:text-indigo-300 font-medium">Registrate</a>
            </p>
        </div>
        
    </div>

    <!-- ADMIN DASHBOARD LAYOUT -->
    <div v-else class="flex h-screen overflow-hidden bg-slate-50 dark:bg-slate-900 transition-colors duration-300">

        <!-- SIDEBAR -->
        <aside class="bg-sidebar text-slate-300 flex flex-col transition-all duration-300 shadow-xl z-30 fixed md:relative h-full" :class="[collapsed ? 'md:w-20' : 'md:w-72',mobileMenuOpen ? 'translate-x-0 w-64' : '-translate-x-full md:translate-x-0 w-64']">

            <!-- LOGO -->
            <div class="h-20 flex items-center justify-center border-b border-slate-800">
                <div class="flex items-center space-x-3" v-if="!collapsed">
                    <img :src="settings.avatar || '../assets/images/logo.jpg'" alt="logo" class="rounded-full h-10">
                    <div>
                        <!-- Nombre de App Dinámico -->
                        <h1 class="font-bold text-lg text-white leading-tight uppercase">
                            {{ currentUserRole === 'superadmin' ? 'SUPER ADMIN' : (settings.appName || 'FOOD ADMIN') }}
                        </h1>
                    </div>
                </div>
                <i class="fa-solid fa-burger text-2xl text-primary" v-else></i>
            </div>

            <!-- BTN POS -->
            <div v-if="currentUserRole != 'superadmin'" class="p-4 border-t border-slate-800">
                <button @click.prevent="settings.plan === 'pro' && navigate({ id: 8, view: 'pos' })" 
                class="flex items-center justify-center w-full py-2 px-4 rounded-lg border border-slate-700 bg-primary text-white shadow-lg transition text-slate-400 text-sm"
                :class="[
                    (settings.plan === 'free') ? 'opacity-80 cursor-not-allowed bg-slate-700' : ''
                ]">
                    <i class="fa-solid fa-cash-register"></i>
                    <span v-if="!collapsed" class="ml-3">Generar Venta</span>
                    <i v-if="settings.plan === 'free'" class="fa-solid fa-lock text-xs text-yellow-500 absolute right-8"></i>
                </button>
            </div>

            <!-- LIST MENU -->
            <nav class="flex-1 overflow-y-auto py-6 pr-3 space-y-1">
                <template v-for="item in activeMenuItems" :key="item.id">
                    <div v-if="!item.children" :class="[
                            currentView === item.view ? 'border-l-4 border-primary' : '',
                        ]"> 
                        <!-- Botón Menú con lógica visual de bloqueo -->
                        <a href="#" 
                        @click.prevent="!item.locked && navigate(item)" 
                        class="text-brand-400 before:rounded-l before:bg-brand-500 before:absolute before:top-0 before:bottom-0 before:-left-3 before:w-1 group flex items-center ml-3 px-2 py-2 text-sm font-medium rounded-md relative"
                        :class="[
                            currentView === item.view ? 'bg-gray-900 text-primary shadow-lg' : 'hover:bg-slate-700 hover:text-white',
                            item.locked ? 'opacity-50 cursor-not-allowed bg-slate-800/50' : '']">
                            <i :class="item.icon" class="w-6 text-center text-lg" :class="currentView === item.view ? 'text-white' : 'text-slate-400'"></i>
                            <span class="ml-3 font-medium" v-if="!collapsed">{{ item.label }}</span>
                            <i v-if="item.locked && !collapsed" class="fa-solid fa-lock text-xs text-yellow-500 absolute right-4"></i>
                        </a>
                    </div>
                    <div v-else>
                        <button @click.prevent="!item.locked && toggleSubmenu(item)" 
                            class="w-full flex items-center justify-between ml-3 px-2 py-2.5 rounded-xl hover:bg-slate-800 hover:text-white text-slate-300 group" 
                            :class="[ item.locked ? 'opacity-50 cursor-not-allowed bg-slate-800/50' : '']">
                            <div class="flex items-center">
                                <i :class="item.icon" class="w-6 text-center text-lg text-slate-400 group-hover:text-white"></i>
                                <span class="ml-3 font-medium" v-if="!collapsed">{{ item.label }}</span>
                            </div>
                            <i v-if="item.locked && !collapsed" class="fa-solid fa-lock text-xs text-yellow-500 absolute right-7"></i>
                            <i v-if="!item.locked && !collapsed" class="fa-solid fa-chevron-down text-xs transition-transform" :class="{'rotate-180': item.expanded}"></i>
                        </button>
                        <transition name="slide">
                            <div v-if="item.expanded && !collapsed" class="pl-12 pr-2 space-y-1 mt-1">
                                <a v-for="sub in item.children" :key="sub.id" href="#" @click.prevent="navigate(sub)" class="block py-2 px-4 rounded-lg text-sm" :class="currentView === sub.view ? 'text-primary bg-slate-800 font-semibold' : 'text-slate-400 hover:text-white hover:bg-slate-800/50'">{{ sub.label }}</a>
                            </div>
                        </transition>
                    </div>
                </template>
            </nav>

            <!-- CLOSE SESSION -->
            <div class="p-4 border-t border-slate-800">
                <button @click="logout" class="flex items-center justify-center w-full py-2 px-4 rounded-lg border border-slate-700 hover:bg-red-500/20 hover:text-red-400 transition text-slate-400 text-sm"><i class="fa-solid fa-right-from-bracket mr-2"></i><span v-if="!collapsed">Salir</span></button>
            </div>
        </aside>

        <!-- BACKDROP: Fondo oscuro para mobile -->
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen = false" class="fixed inset-0 bg-black/50 z-20 md:hidden glass transition-opacity"></div>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">

            <!-- Top Header -->
            <header class="h-20 bg-white dark:bg-slate-800 shadow-sm flex items-center justify-between px-4 md:px-8 z-10 border-b dark:border-slate-700">
                <button @click="toggleSidebar" class="text-slate-500 hover:text-primary transition focus:outline-none"><i class="fa-solid fa-bars-staggered text-2xl"></i></button>
                <div class="flex items-center space-x-4 md:space-x-6">
                    
                    <button v-if="settings.plan == 'pro' && finance.shiftStatus.value === 'closed'" @click="finance.showOpenModal.value = true" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm px-3 py-1.5 rounded-xl shadow-lg shadow-emerald-500/30 font-bold transition">
                        <i class="fa-solid fa-lock-open lg:mr-2"></i> <span class="hidden md:inline"> Abrir Caja</span>
                    </button>
                    <button v-if="settings.plan == 'pro' && finance.shiftStatus.value === 'open'" @click="finance.showCloseModal.value = true" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1.5 rounded-xl shadow-lg shadow-red-500/30 font-bold transition">
                        <i class="fa-solid fa-lock lg:mr-2"></i> <span class="hidden md:inline"> Cerrar Caja (Corte)</span>
                    </button>
                    
                    <button @click="toggleTheme" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 flex items-center justify-center hover:bg-slate-200 transition"><i class="fa-solid" :class="isDark ? 'fa-sun' : 'fa-moon'"></i></button>
                    <div class="flex items-center space-x-2">
                        <div class="text-right hidden md:block"><p class="text-sm font-bold text-slate-800 dark:text-white">{{ username }}</p><p class="text-xs text-slate-500 uppercase">{{ currentUserRole === 'superadmin' ? 'Super Admin' : 'Gerente' }}</p></div>
                        <img v-if="settings.avatar" :src="settings.avatar" class="w-10 h-10 object-cover rounded-full ">
                        <div v-else class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold">A</div>
                    </div>
                </div>
            </header>

            <!-- Content Scrollable -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-50 dark:bg-slate-900 p-8 transition-colors duration-300">
                <!-- === VISTAS SUPER ADMIN === -->
                <!-- SAAS CLIENTS VIEW -->
                <div v-if="currentView === 'saas_clients'" class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Gestión de Negocios</h2><button @click="openSaasModal()" class="bg-primary hover:bg-primaryDark text-white px-6 py-2.5 rounded-xl shadow-lg transition"><i class="fa-solid fa-plus mr-2"></i> Registrar Negocio</button></div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 dark:bg-slate-700 text-xs uppercase text-slate-500 dark:text-slate-300"><tr><th class="p-4">Negocio</th><th class="p-4">URL Slug</th><th class="p-4">Plan</th><th class="p-4 text-center">Estado</th><th class="p-4 text-right">Acciones</th></tr></thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                <tr v-for="biz in businesses" :key="biz._id" class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                                    <td class="p-4 font-bold text-slate-800 dark:text-white">{{ biz.name }}</td><td class="p-4 text-sm text-slate-500">/menu/{{ biz.slug }}</td><td class="p-4"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded uppercase font-bold">{{ biz.plan }}</span></td>
                                    <td class="p-4 text-center"><button @click="toggleStatus(biz)" class="px-3 py-1 rounded-full text-xs font-bold transition w-24" :class="biz.active ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-red-100 text-red-700 hover:bg-red-200'">{{ biz.active ? 'ACTIVO' : 'BLOQUEADO' }}</button></td>
                                    <td class="p-4 text-right"><div class="flex justify-end gap-2"><button @click="openSaasModal(biz)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-blue-100 hover:text-blue-600 transition flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button><button @click="deleteBusiness(biz._id)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-red-100 hover:text-red-600 transition flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- === VISTAS NEGOCIO === -->
                <!-- DASHBOARD VIEW -->
                <div v-if="currentView === 'dashboard'" class="animate-fade-in space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Panel de Control</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div v-for="kpi in kpis" :key="kpi.label" class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 flex items-center hover:shadow-md transition-shadow">
                            <div :class="`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl mr-4 ${kpi.colorBg} ${kpi.colorText}`"><i :class="kpi.icon"></i></div>
                            <div><h3 class="text-2xl font-bold text-slate-800 dark:text-white">{{ kpi.value }}</h3><p class="text-sm text-slate-500">{{ kpi.label }}</p></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
                        <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-80">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-4">Ventas Última Semana</h3>
                            <div class="flex-1 relative w-full h-full"><canvas id="salesChart"></canvas></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 h-80 overflow-y-auto">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-4">Más Vendidos</h3>
                            <div v-if="topProducts.length === 0" class="text-center text-slate-400 py-10"><i class="fa-solid fa-basket-shopping text-2xl mb-2"></i><p class="text-xs">Aún no hay ventas</p></div>
                            <ul v-else class="space-y-4">
                                <li v-for="(prod, idx) in topProducts" :key="idx" class="flex items-center">
                                    <div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-700 mr-3 overflow-hidden shrink-0"><img :src="prod.image || 'https://via.placeholder.com/50'" class="w-full h-full object-cover"></div>
                                    <div class="flex-1 min-w-0"><p class="text-sm font-bold text-slate-800 dark:text-white truncate">{{ prod.name }}</p><p class="text-xs text-slate-500 dark:text-slate-400">{{ prod.salesCount }} vendidos</p></div>
                                    <span class="text-primary font-bold text-sm">${{ prod.price }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- POS VIEW -->
                <div v-if="currentView === 'pos'" class="h-screen md:h-full flex flex-col -m-4 md:-m-8 animate-fade-in text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900">
                    <div class="grid grid-cols-1 lg:grid-cols-[1fr_minmax(380px,_850px)] h-full overflow-hidden">
                        
                        <!-- IZQUIERDA: ACCIONES Y BUSCADOR -->
                        <div class="p-4 md:p-6 flex flex-col gap-4 md:gap-6 overflow-y-auto bg-white dark:bg-slate-800 lg:bg-slate-50 lg:dark:bg-slate-900 border-b lg:border-b-0 lg:border-r dark:lg:border-slate-700 order-2 lg:order-1">
                            
                            <!-- 1. BUSCADOR TIPO AUTOCOMPLETE -->
                            <div class="relative w-full z-40">
                                <div class="relative shadow-sm">
                                    <i class="fa-solid fa-magnifying-glass absolute left-4 md:left-5 top-2 md:top-4 text-slate-400 text-lg"></i>
                                    
                                    <input 
                                        v-model="pos.searchQuery.value" 
                                        @keyup.enter="pos.handleSearchEnter"
                                        @focus="pos.isSearchFocused.value = true"
                                        @blur="pos.isSearchFocused.value = true"
                                        type="text" 
                                        placeholder="Escanear o buscar..." 
                                        class="w-full pl-12 md:pl-14 pr-12 md:pr-14 py-3 md:py-4 rounded-2xl border-none bg-white dark:bg-slate-700 text-sm md:text-lg shadow-lg focus:ring-4 focus:ring-primary/20 outline-none transition-all">
                                    
                                    <!-- Botón Cámara -->
                                    <button @click="pos.startCameraScanner" class="absolute right-3 top-0 md:top-1.5 p-2 text-slate-400 hover:text-primary transition flex-shrink-0">
                                        <i class="fa-solid fa-barcode text-xl"></i>
                                    </button>
                                </div>

                                <!-- LISTA DESPLEGABLE DE RESULTADOS -->
                                <div v-if="pos.isSearchFocused.value || pos.searchQuery.value" 
                                    class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-700 max-h-[50vh] md:max-h-[60vh] overflow-y-auto overflow-x-hidden z-40">
                                    
                                    <!-- Lista de Productos Filtrados -->
                                    <div v-for="prod in products.filter( p => p.name.toLowerCase().includes(pos.searchQuery.value.toLowerCase()) || ( p.barcode && p.barcode.includes(pos.searchQuery.value) ) )" 
                                        :key="prod._id"
                                        @click="pos.addToCart(prod)"
                                        class="flex items-center justify-between p-3 md:p-4 border-b border-slate-50 dark:border-slate-700 hover:bg-indigo-50 dark:hover:bg-slate-700 cursor-pointer transition">
                                        
                                        <div class="flex items-center gap-3 md:gap-4 min-w-0">
                                            <div class="w-10 md:w-12 h-10 md:h-12 rounded-lg bg-slate-100 dark:bg-slate-700 overflow-hidden shrink-0">
                                                <img :src="prod.image || 'https://via.placeholder.com/50'" class="w-full h-full object-cover">
                                            </div>
                                            <div class="min-w-0">
                                                <h4 class="font-bold text-slate-800 dark:text-white text-sm md:text-base truncate">{{ prod.name }}</h4>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate">{{ prod.barcode || 'Sin código' }}</p>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-2 md:gap-6 text-right flex-shrink-0">
                                            <div>
                                                <span class="block font-bold text-primary text-sm md:text-lg">${{ prod.price }}</span>
                                            </div>
                                            <div class="text-xs font-bold px-1.5 md:px-2 py-0.5 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 whitespace-nowrap">
                                                {{ prod.stock || '∞' }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Empty State -->
                                    <div v-if="products.filter(p => p.name.toLowerCase().includes(pos.searchQuery.value.toLowerCase())).length === 0" class="p-6 md:p-8 text-center text-slate-400">
                                        <i class="fa-solid fa-box-open text-xl md:text-2xl mb-2"></i>
                                        <p class="text-sm md:text-base">No se encontraron productos</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. GRID DE ACCIONES RÁPIDAS -->
                            <div class="grid grid-cols-2 gap-2 md:gap-4 flex-1 content-start">
                                <!-- Agregar Cliente -->
                                <button @click="pos.openCustomerModal" class="h-24 md:h-32 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-transparent hover:border-primary hover:shadow-md transition flex flex-col items-center justify-center gap-1 md:gap-2 group">
                                    <div class="w-9 md:w-12 h-9 md:h-12 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-lg md:text-xl group-hover:scale-110 transition">
                                        <i class="fa-solid fa-user-plus"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-xs md:text-sm text-center leading-tight">Cliente</span>
                                </button>
                                
                                <!-- Descuento -->
                                <button @click="pos.openDiscountModal" class="h-24 md:h-32 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-transparent hover:border-red-500 hover:shadow-md transition flex flex-col items-center justify-center gap-1 md:gap-2 group">
                                    <div class="w-9 md:w-12 h-9 md:h-12 rounded-full bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center text-lg md:text-xl group-hover:scale-110 transition">
                                        <i class="fa-solid fa-tag"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-xs md:text-sm text-center leading-tight">Descuento</span>
                                </button>
                                
                                <!-- Cambiar Vendedor
                                <button @click="pos.changeSalesperson" class="h-24 md:h-32 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-transparent hover:border-purple-500 hover:shadow-md transition flex flex-col items-center justify-center gap-1 md:gap-2 group">
                                    <div class="w-9 md:w-12 h-9 md:h-12 rounded-full bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center text-lg md:text-xl group-hover:scale-110 transition"><i class="fa-solid fa-id-badge"></i></div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-xs md:text-sm text-center leading-tight">Vendedor</span>
                                </button> -->
                                
                                <!-- Servicios / Recargas 
                                <button @click="pos.triggerRecargas" class="h-24 md:h-32 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-transparent hover:border-emerald-500 hover:shadow-md transition flex flex-col items-center justify-center gap-1 md:gap-2 group">
                                    <div class="w-9 md:w-12 h-9 md:h-12 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center text-lg md:text-xl group-hover:scale-110 transition"><i class="fa-solid fa-mobile-screen-button"></i></div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-xs md:text-sm text-center leading-tight">Servicios</span>
                                </button>-->
                            </div>
                        </div>

                        <!-- DERECHA: CARRITO -->
                        <div class="flex flex-col bg-white dark:bg-slate-800 min-h-0 overflow-hidden order-1 lg:order-2">
                            <!-- Tabs -->
                            <div class="px-2 md:px-3 pt-2 md:pt-3 flex overflow-x-auto border-b dark:border-slate-700 hide-scroll dark:bg-slate-700 gap-1">
                                <div v-for="tab in pos.posTabs.value" :key="tab.id" 
                                    @click="pos.activeTabId.value = tab.id"
                                    class="px-3 md:px-6 py-2 md:py-3 cursor-pointer flex items-center gap-1 md:gap-2 min-w-[80px] md:min-w-[100px] transition-colors rounded-t-lg translate-y-px box-border whitespace-nowrap text-xs md:text-sm"
                                    :class="pos.activeTabId.value === tab.id ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white' : 'text-slate-500 bg-slate-100 hover:bg-white dark:bg-slate-700 dark:hover:bg-slate-900 dark:hover:text-white'">
                                    <span class="font-medium truncate">{{ tab.name }}</span>
                                    <i @click.stop="pos.removeTab(tab.id)" class="fa-solid fa-xmark text-xs opacity-50 hover:opacity-100 flex-shrink-0"></i>
                                </div>
                                <button @click="pos.addTab" v-if="pos.posTabs.value.length <= 5" class="px-2 md:px-3 bg-slate-50 dark:bg-slate-700 dark:text-white text-slate-500 hover:text-primary text-sm md:text-base"><i class="fa-solid fa-plus"></i></button>
                            </div>

                            <!-- Cliente Info -->
                            <div class="px-3 md:px-4 py-2 md:py-3 bg-indigo-50 dark:bg-slate-800 flex justify-between items-center text-xs md:text-sm border-b border-indigo-100 dark:border-slate-700 gap-2">
                                <div class="flex items-center gap-1.5 md:gap-2 min-w-0">
                                    <div class="w-6 md:w-8 h-6 md:h-8 rounded-full bg-indigo-200 dark:bg-indigo-800 flex items-center justify-center text-indigo-700 dark:text-indigo-200 font-bold flex-shrink-0 text-xs md:text-sm">
                                        <i v-if="!pos.activeTab.value.customer" class="fa-solid fa-user text-xs md:text-sm"></i>
                                        <span v-else>{{ pos.activeTab.value.customer.name[0] }}</span>
                                    </div>
                                    <div class="min-w-0">
                                        <span class="block font-bold text-slate-700 dark:text-slate-200 text-xs md:text-sm truncate">
                                            {{ pos.activeTab.value.customer ? pos.activeTab.value.customer.name : 'Mostrador' }}
                                        </span>
                                        <span v-if="pos.activeTab.value.customer" class="text-[9px] md:text-[10px] text-indigo-600 dark:text-indigo-300 truncate">
                                            {{ pos.activeTab.value.customer.points }} Pts
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-1 flex-shrink-0">
                                    <button v-if="pos.activeTab.value.customer" @click="pos.removeCustomer" class="text-red-500 hover:text-red-700 font-medium bg-white dark:bg-slate-800 px-1.5 md:px-2 py-0.5 rounded shadow-sm text-xs">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                    <button v-else @click="pos.openCustomerModal" class="text-primary hover:underline font-medium text-xs">Buscar</button>
                                </div>
                            </div>

                            <!-- Lista Items (CARRITO) -->
                            <div class="flex-1 overflow-y-auto p-3 md:p-4 space-y-2 md:space-y-3 bg-slate-50 dark:bg-slate-700">
                                <div v-if="pos.activeTab.value.cart.length === 0" class="h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-600">
                                    <i class="fa-solid fa-cart-shopping text-4xl md:text-6xl mb-2 md:mb-4 opacity-50"></i>
                                    <p class="font-medium text-xs md:text-base text-center">Escanea productos</p>
                                </div>
                                
                                <div v-for="item in pos.activeTab.value.cart" :key="item._id" class="flex flex-col p-2 md:p-3 rounded-lg md:rounded-xl bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700 group gap-2">
                                    <!-- IMAGEN DEL PRODUCTO -->
                                    <div @click="openItemDetails(item)" class="flex items-start justify-between gap-2 cursor-pointer hover:opacity-80 transition select-none">
                                        <div class="flex items-center gap-2 min-w-0 flex-1">
                                            <div class="w-10 md:w-12 h-10 md:h-12 rounded-lg bg-slate-100 dark:bg-slate-700 shrink-0 overflow-hidden border border-slate-200 dark:border-slate-600">
                                                <img :src="item.image || 'https://via.placeholder.com/100'" class="w-full h-full object-cover">
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <p class="text-xs md:text-sm font-bold text-slate-800 dark:text-white truncate flex items-center gap-1">
                                                    {{ item.name }}
                                                    <i class="fa-solid fa-circle-info text-[8px] md:text-[10px] text-slate-400 flex-shrink-0"></i>
                                                </p>
                                                <p class="text-[10px] md:text-xs text-slate-500">${{ item.price }}/u</p>
                                                <div v-if="item.selectedOptions && item.selectedOptions.length > 0" class="flex flex-wrap gap-0.5 mt-0.5">
                                                    <span v-for="(opt, idx) in item.selectedOptions.slice(0, 1)" :key="idx" class="text-[8px] md:text-[10px] px-1 py-0.5 rounded bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 font-medium truncate max-w-[120px]">
                                                        +{{ opt.name }}
                                                    </span>
                                                    <span v-if="item.selectedOptions.length > 1" class="text-[8px] md:text-[10px] px-1 py-0.5 rounded bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 font-medium">
                                                        +{{ item.selectedOptions.length - 1 }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right flex-shrink-0">
                                            <span class="block font-black text-slate-800 dark:text-white text-sm md:text-base">${{ (item.price * item.qty).toFixed(2) }}</span>
                                        </div>
                                    </div>

                                    <!-- Controles Cantidad -->
                                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 rounded-lg p-1">
                                        <div class="flex items-center gap-1 md:gap-2">
                                            <button @click="pos.updateQty(item._id, -1)" class="w-7 md:w-10 h-7 md:h-10 flex items-center justify-center bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-200 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 active:scale-95 transition text-xs md:text-sm">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            
                                            <span class="font-black text-center dark:text-white text-xs md:text-lg w-6 md:w-8">{{ item.qty }}</span>
                                            
                                            <button @click="pos.updateQty(item._id, 1)" class="w-7 md:w-10 h-7 md:h-10 flex items-center justify-center bg-white dark:bg-slate-800 text-primary rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 active:scale-95 transition text-xs md:text-sm">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>

                                        <!-- Botón Eliminar -->
                                        <button @click="pos.removeFromCart(item._id)" class="w-7 md:w-10 h-7 md:h-10 flex items-center justify-center text-red-500 bg-white dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg shadow-sm active:scale-95 transition border border-slate-200 dark:border-slate-600 text-xs md:text-sm flex-shrink-0 ml-1">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Totales y Cobro -->
                            <div class="p-3 md:p-6 bg-white dark:bg-slate-800 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-20">
                                <div class="space-y-1 md:space-y-2 text-xs md:text-sm mb-3 md:mb-4">
                                    <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                        <span>Subtotal</span>
                                        <span class="font-medium">${{ pos.currentTotals.value.subtotal.toFixed(2) }}</span>
                                    </div>
                                    <div v-if="pos.currentTotals.value.discountAmount > 0" class="flex justify-between text-red-500">
                                        <span>Descuento</span>
                                        <span class="font-bold">-${{ pos.currentTotals.value.discountAmount.toFixed(2) }}</span>
                                    </div>
                                    <div class="flex justify-between text-slate-600 dark:text-slate-400" v-if="settings.iva > 0">
                                        <span>IVA ({{ settings.iva }}%)</span>
                                        <span class="font-medium">${{ pos.currentTotals.value.tax.toFixed(2) }}</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-end mb-3 md:mb-6">
                                    <span class="text-slate-800 dark:text-white font-bold text-sm md:text-lg">Total</span>
                                    <span class="text-2xl md:text-3xl font-black text-slate-900 dark:text-white leading-none">${{ pos.currentTotals.value.total.toFixed(2) }}</span>
                                </div>
                                <button @click="pos.openPayment" class="w-full bg-slate-900 dark:bg-primary hover:bg-slate-800 text-white font-bold py-3 md:py-4 rounded-lg md:rounded-xl shadow-lg shadow-slate-900/20 text-sm md:text-lg flex justify-between px-4 md:px-6 transition active:scale-95">
                                    <span>Cobrar</span>
                                    <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div> 

                <!-- LOYALTY VIEW -->
                <div v-if="currentView === 'loyalty'" class="space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Programa de Lealtad</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Configuración</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between"><span class="text-sm text-slate-600 dark:text-slate-300">Activar Programa</span><label class="inline-flex items-center cursor-pointer"><input type="checkbox" v-model="program.active" class="sr-only peer"><div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div>
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Tipo</label><select v-model="program.type" class="w-full px-3 py-2 border rounded-lg bg-slate-50 dark:bg-slate-900 dark:border-slate-600 dark:text-white"><option value="points">Puntos ($)</option><option value="stamps">Sellos (Visitas)</option></select></div>
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Meta</label><input v-model="program.goal" type="number" class="w-full px-3 py-2 border rounded-lg bg-slate-50 dark:bg-slate-900 dark:border-slate-600 dark:text-white"></div>
                                <div><label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Premio</label><input v-model="program.reward" type="text" class="w-full px-3 py-2 border rounded-lg bg-slate-50 dark:bg-slate-900 dark:border-slate-600 dark:text-white"></div>
                                <button @click="saveProgram" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primaryDark">Guardar</button>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center text-center">
                            <div class="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4"><i class="fa-solid fa-qrcode text-4xl text-slate-400"></i></div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">Escanear</h3>
                            <button @click="startScanner" class="mt-4 bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition shadow-lg"><i class="fa-solid fa-camera mr-2"></i> Cámara</button>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS VIEW (CON DATATABLES) -->
                <div v-if="currentView === 'products'" class="space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Productos</h2><p class="text-slate-500 dark:text-slate-400">Gestión de platillos</p></div>
                        <button @click="openProductModal(null, mediaFiles.length)" class="bg-primary hover:bg-primaryDark text-white px-6 py-2.5 rounded-xl shadow-lg transition flex items-center w-full md:w-auto justify-center"><i class="fa-solid fa-plus mr-2"></i> Nuevo Producto</button>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden p-4">
                        <table id="productsTable" class="w-full text-left display responsive nowrap" style="width:100%">
                            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase"><tr><th>Imagen</th><th>Nombre</th><th>Precio</th><th>Categorías</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- MEDIA LIBRARY VIEW -->
                <div v-if="currentView === 'media'" class="h-full flex flex-col animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Biblioteca de Medios</h2><p class="text-slate-500 dark:text-slate-400">Gestiona imágenes y videos</p></div>
                        <div class="flex items-center gap-3 w-full md:w-auto"><input type="file" ref="fileInput" @change="uploadFile" class="hidden" accept="image/*,video/*"><button @click="$refs.fileInput.click()" class="bg-primary hover:bg-primaryDark text-white px-6 py-2.5 rounded-xl shadow-lg transition flex items-center justify-center w-full md:w-auto"><i class="fa-solid fa-cloud-arrow-up mr-2"></i><span v-if="isUploading">Subiendo...</span><span v-else>Subir Nuevo</span></button></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6 flex flex-col md:flex-row gap-4 items-center">
                        <div class="flex-1 w-full relative"><i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i><input v-model="mediaFilters.search" type="text" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary text-sm"></div>
                        <div class="w-full md:w-40"><select v-model="mediaFilters.type" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary text-sm"><option value="all">Todos</option><option value="image">Imágenes</option><option value="video">Videos</option></select></div>
                        <button @click="clearMediaFilters" class="text-slate-500 hover:text-red-500 px-3 py-2" title="Limpiar"><i class="fa-solid fa-filter-circle-xmark text-lg"></i></button>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 overflow-y-auto">
                        <div v-if="filteredMedia.length === 0" class="text-center text-slate-400 py-10"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-50"></i><p>No se encontraron archivos.</p></div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-9 gap-4">
                            <div v-for="img in filteredMedia" :key="img.name" class="aspect-square relative group rounded-xl overflow-hidden cursor-pointer border border-slate-200 dark:border-slate-600 bg-slate-100 dark:bg-slate-700">
                                <video v-if="isVideo(img.name)" :src="img.url" class="w-full h-full object-cover"></video>
                                <img v-else :src="img.url" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-3">
                                    <button @click="deleteFile(img.name)" class="w-10 h-10 bg-white rounded-full text-red-500 flex items-center justify-center shadow-lg"><i class="fa-solid fa-trash-can"></i></button>
                                    <button @click="copyToClipboard(img.url)" class="w-10 h-10 bg-white rounded-full text-blue-500 flex items-center justify-center shadow-lg"><i class="fa-solid fa-link"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CATEGORÍAS VIEW -->
                <div v-if="currentView === 'categories'" class="space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Categorías</h2><p class="text-slate-500 dark:text-slate-400">Organiza tu menú en secciones</p></div>
                        <button @click="openCategoryModal(null, mediaFiles.length)" class="bg-secondary hover:bg-emerald-600 text-white px-6 py-2.5 rounded-xl shadow-lg transition flex items-center w-full md:w-auto justify-center"><i class="fa-solid fa-plus mr-2"></i> Nueva Categoría</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <div v-for="cat in categoriesList" :key="cat._id" class="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col group hover:shadow-md transition">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-700">
                                    <img v-if="cat.image" :src="cat.image" class="w-full h-full object-cover">
                                    <div v-else class="w-full h-full flex items-center justify-center text-slate-400"><i class="fa-solid fa-utensils"></i></div>
                                </div>
                                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="openCategoryModal(cat, mediaFiles.length)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-primary hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>
                                    <button @click="deleteCategory(cat._id)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-1">{{ cat.name }}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 mb-3">{{ cat.description || 'Sin descripción' }}</p>
                            <div class="mt-auto pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center"><span class="text-xs font-medium px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">{{ cat.active ? 'Visible' : 'Oculta' }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- ADDONS VIEW -->
                <div v-if="currentView === 'addons'" class="space-y-6 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Complementos y Extras</h2><p class="text-slate-500 dark:text-slate-400">Grupos de opciones</p></div>
                        <button @click="openAddonModal()" class="bg-secondary hover:bg-emerald-600 text-white px-6 py-2.5 rounded-xl shadow-lg transition flex items-center w-full md:w-auto justify-center"><i class="fa-solid fa-plus mr-2"></i> Nuevo Grupo</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="addon in addonsList" :key="addon._id" class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col overflow-hidden">
                            <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-700/30 flex justify-between items-start">
                                <div><h3 class="font-bold text-lg text-slate-800 dark:text-white">{{ addon.name }}</h3><div class="flex gap-2 mt-1"><span class="text-xs px-2 py-0.5 rounded font-medium" :class="addon.required ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400'">{{ addon.required ? 'Obligatorio' : 'Opcional' }}</span><span class="text-xs px-2 py-0.5 rounded bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300">Max: {{ addon.maxOptions }}</span></div></div>
                                <div class="flex space-x-1"><button @click="openAddonModal(addon)" class="text-slate-400 hover:text-primary p-1"><i class="fa-solid fa-pen"></i></button><button @click="deleteAddon(addon._id)" class="text-slate-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button></div>
                            </div>
                            <div class="p-5 flex-1"><p class="text-xs text-slate-400 uppercase font-bold mb-3 tracking-wider">Opciones ({{ addon.options.length }})</p><ul class="space-y-2"><li v-for="(opt, idx) in addon.options.slice(0, 4)" :key="idx" class="flex justify-between text-sm text-slate-600 dark:text-slate-300"><span>{{ opt.name }}</span><span v-if="opt.priceExtra > 0" class="text-emerald-600 dark:text-emerald-400 font-medium">+${{ opt.priceExtra }}</span><span v-else class="text-slate-400 text-xs">Gratis</span></li></ul></div>
                        </div>
                    </div>
                </div>

                <!-- ADS VIEW (PUBLICIDAD) -->
                <div v-if="currentView === 'ads'" class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Publicidad y Banners</h2><p class="text-slate-500 dark:text-slate-400">Promociones visibles en el menú</p></div>
                        <button @click="openBannerModal(null, mediaFiles.length)" class="bg-secondary hover:bg-emerald-600 text-white px-6 py-2.5 rounded-xl shadow-lg transition flex items-center"><i class="fa-solid fa-plus mr-2"></i> Crear Banner</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                        <div v-for="banner in banners" :key="banner._id" class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden group hover:shadow-md transition">
                            <div class="h-40 bg-slate-200 dark:bg-slate-700 relative overflow-hidden">
                                <img :src="banner.imageUrl" class="w-full h-full object-cover">
                                <div class="absolute top-4 right-4 text-xs font-bold px-2 py-1 rounded-md shadow-sm" :class="banner.active ? 'bg-green-500 text-white' : 'bg-slate-500 text-white'">{{ banner.active ? 'ACTIVO' : 'INACTIVO' }}</div>
                            </div>
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-2"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ banner.title }}</h3><div class="flex space-x-2"><button @click="openBannerModal(banner, mediaFiles.length)" class="text-slate-400 hover:text-primary"><i class="fa-solid fa-pen"></i></button><button @click="deleteBanner(banner._id)" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div>
                                <p class="text-slate-500 dark:text-slate-400 text-sm mb-4 line-clamp-2">{{ banner.description }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW LISTADO DE VENTAS -->
                <div v-if="currentView === 'orders'" class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Historial de Ventas</h2>
                            <p class="text-slate-500 dark:text-slate-400">Registro de todas las transacciones POS y Web</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="orders.fetchOrders" class="w-10 h-10 rounded-xl bg-white dark:bg-slate-800 shadow text-slate-500 hover:text-primary transition flex items-center justify-center"><i class="fa-solid fa-rotate"></i></button>
                            <button @click="downloadSalesExcel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                                <i class="fa-solid fa-file-excel"></i> Descargar Excel
                            </button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden p-4">
                        <table id="ordersTable" class="w-full text-left display responsive nowrap" style="width:100%">
                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-300 text-xs uppercase">
                                <tr>
                                    <th>Folio</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Canal</th>
                                    <th>Método</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW DETALLE DE VENTA -->
                <div v-if="currentView === 'order_details'" class="animate-fade-in pb-10">
                    <!-- Loading State -->
                    <div v-if="orders.isLoading.value" class="h-96 flex flex-col items-center justify-center text-slate-400">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-primary"></i>
                        <p>Cargando detalles del pedido...</p>
                    </div>

                    <div v-else-if="orders.selectedOrder.value">
                        <!-- Header con Acciones -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                            <div class="flex items-center gap-4">
                                <button @click="viewListOrders" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                                    <i class="fa-solid fa-arrow-left text-slate-500 dark:text-slate-300"></i>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        Orden #{{ orders.selectedOrder.value._id.slice(-6).toUpperCase() }}
                                        <span class="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wide"
                                            :class="{
                                                'bg-green-100 text-green-700': orders.selectedOrder.value.status === 'completed',
                                                'bg-red-100 text-red-700': orders.selectedOrder.value.status === 'cancelled',
                                                'bg-yellow-100 text-yellow-700': orders.selectedOrder.value.status === 'pending'
                                            }">
                                            {{ orders.selectedOrder.value.status }}
                                        </span>
                                    </h2>
                                    <p class="text-slate-500 text-sm">{{ new Date(orders.selectedOrder.value.createdAt).toLocaleString() }}</p>
                                </div>
                            </div>
                            
                            <!-- Botones Acción -->
                            <div class="flex flex-wrap gap-2">
                                <button @click="openTicketPreview" class="bg-slate-800 dark:bg-white dark:text-slate-900 text-white px-4 py-2 rounded-lg font-bold shadow hover:opacity-90 transition"><i class="fa-solid fa-receipt mr-2"></i>Ticket</button>
                                <button @click="generatePDF" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-red-600 transition"><i class="fa-solid fa-file-pdf mr-2"></i>PDF</button>
                                <button @click="openShareModal" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-600 transition"><i class="fa-brands fa-whatsapp mr-2"></i>Compartir</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <!-- COLUMNA IZQUIERDA: PRODUCTOS -->
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                    <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                                        <h3 class="font-bold text-slate-800 dark:text-white">Productos Adquiridos</h3>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-sm">
                                            <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 uppercase text-xs">
                                                <tr>
                                                    <th class="p-4">Producto</th>
                                                    <th class="p-4 text-center">Cant.</th>
                                                    <th class="p-4 text-right">Precio U.</th>
                                                    <th class="p-4 text-right">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                                <tr v-for="(item, idx) in orders.selectedOrder.value.items" :key="idx">
                                                    <td class="p-4">
                                                        <p class="font-bold text-slate-800 dark:text-white">{{ item.name }}</p>
                                                        <!-- Mostrar complementos -->
                                                        <div v-if="item.selectedOptions && item.selectedOptions.length > 0" class="flex flex-wrap gap-1 mt-1">
                                                            <span v-for="opt in item.selectedOptions" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300">
                                                                + {{ opt.name }} (${{ opt.price }})
                                                            </span>
                                                        </div>
                                                        <p v-if="item.note" class="text-xs text-orange-500 italic mt-0.5"><i class="fa-solid fa-note-sticky mr-1"></i>{{ item.note }}</p>
                                                    </td>
                                                    <td class="p-4 text-center text-slate-600 dark:text-slate-300">{{ item.quantity }}</td>
                                                    <td class="p-4 text-right text-slate-600 dark:text-slate-300">${{ item.price.toFixed(2) }}</td>
                                                    <td class="p-4 text-right font-bold text-slate-800 dark:text-white">
                                                        ${{ ((item.price + (item.selectedOptions ? item.selectedOptions.reduce((a,b)=>a+(b.price||0),0) : 0)) * item.quantity).toFixed(2) }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- COLUMNA DERECHA: TOTALES E INFO -->
                            <div class="space-y-6">
                                
                                <!-- Card Financiero -->
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-800 dark:text-white mb-4">Resumen Financiero</h3>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between text-slate-500 dark:text-slate-400">
                                            <span>Subtotal</span>
                                            <span>${{ orders.selectedOrder.value.subtotal?.toFixed(2) || '0.00' }}</span>
                                        </div>
                                        <div v-if="orders.selectedOrder.value.discount > 0" class="flex justify-between text-red-500">
                                            <span>Descuentos</span>
                                            <span>-${{ orders.selectedOrder.value.discount?.toFixed(2) }}</span>
                                        </div>
                                        <div class="flex justify-between text-slate-500 dark:text-slate-400 border-b border-slate-100 dark:border-slate-700 pb-3">
                                            <span>IVA (16%)</span>
                                            <span>${{ orders.selectedOrder.value.tax?.toFixed(2) || '0.00' }}</span>
                                        </div>
                                        <div class="flex justify-between items-end pt-1">
                                            <span class="font-bold text-slate-800 dark:text-white text-lg">Total</span>
                                            <span class="font-black text-2xl text-slate-900 dark:text-white">${{ orders.selectedOrder.value.total.toFixed(2) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card Información / Metadata -->
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h3 class="font-bold text-slate-800 dark:text-white mb-4">Información de Venta</h3>
                                    
                                    <div class="space-y-4">
                                        <!-- Cliente -->
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 flex items-center justify-center">
                                                <i class="fa-solid fa-user"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-400 uppercase font-bold">Cliente</p>
                                                <p class="font-bold text-slate-800 dark:text-white text-sm">
                                                    {{ orders.selectedOrder.value.customerId ? orders.selectedOrder.value.customerId.name : 'Venta Mostrador' }}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Cajero / Usuario -->
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 text-slate-500 flex items-center justify-center">
                                                <i class="fa-solid fa-id-badge"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-400 uppercase font-bold">Atendido por</p>
                                                <p class="font-medium text-slate-700 dark:text-slate-300 text-sm">
                                                    {{ orders.selectedOrder.value.createdBy ? orders.selectedOrder.value.createdBy.username : 'Sistema' }}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Canal y Método -->
                                        <div class="grid grid-cols-2 gap-4 pt-2">
                                            <div>
                                                <p class="text-xs text-slate-400 uppercase font-bold mb-1">Canal</p>
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-blue-50 text-blue-700 uppercase">
                                                    {{ orders.selectedOrder.value.source }}
                                                </span>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-400 uppercase font-bold mb-1">Pago</p>
                                                <span class="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-700 uppercase">
                                                    {{ orders.selectedOrder.value.paymentMethod }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Botón Factura -->
                                    <button @click="orders.generateInvoice" class="w-full mt-6 py-3 border-2 border-slate-200 dark:border-slate-600 rounded-xl text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition flex justify-center items-center gap-2">
                                        <i class="fa-solid fa-file-invoice"></i> Generar Factura
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: COTIZACIONES (LISTA) -->
                <div v-if="currentView === 'quotes'" class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold dark:text-white">Cotizaciones</h2>
                        <button @click="startNewQuote" class="bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-lg font-bold shadow transition">
                            <i class="fa-solid fa-plus mr-2"></i> Generar nueva cotización</button>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border dark:border-slate-700">
                        <table id="quotesTable" class="w-full text-sm text-left">
                            <thead class="text-slate-500 bg-slate-50 dark:bg-slate-900 uppercase text-xs">
                                <tr>
                                    <th class="p-3">Folio</th>
                                    <th class="p-3">Cliente</th>
                                    <th class="p-3">Validez</th>
                                    <th class="p-3">Total</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3 flex gap-2 justify-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA: EDITOR DE COTIZACIÓN -->
                <div v-if="currentView === 'quote_editor'" class="h-screen md:h-full flex flex-col -m-4 md:-m-8 bg-slate-50 dark:bg-slate-900">
                    <!-- Header -->
                    <div class="bg-white dark:bg-slate-800 border-b dark:border-slate-700 p-4 md:p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 shadow-sm z-10">
                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <button @click="viewListQuotes()" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500 hover:text-primary transition flex-shrink-0">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <h2 class="font-bold text-lg md:text-xl dark:text-white truncate">{{ quotes.isEditing.value ? 'Editar' : 'Nueva' }} Cotización</h2>
                        </div>
                        <button @click="saveQuote" class="bg-primary text-white px-4 md:px-6 py-2.5 md:py-2 rounded-lg font-bold shadow hover:bg-primaryDark transition w-full md:w-auto">
                            <i class="fa-solid fa-save mr-2"></i> <span class="hidden md:inline">Guardar</span><span class="md:hidden">Guardar</span>
                        </button>
                    </div>

                    <!-- Main Content -->
                    <div class="flex flex-col lg:flex-row flex-1 overflow-hidden">
                        <!-- Panel Izquierdo: Formulario -->
                        <div class="w-full lg:w-1/3 bg-white dark:bg-slate-800 lg:bg-slate-50 lg:dark:bg-slate-900 border-r-0 lg:border-r dark:lg:border-slate-700 flex flex-col overflow-y-auto order-2 lg:order-1">
                            <div class="p-4 md:p-6 space-y-4">
                                <!-- BUSCADOR PRODUCTOS -->
                                <div class="pt-4 border-t dark:border-slate-700 relative">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Agregar Productos</label>
                                    <div class="relative">
                                        <input 
                                            v-model="quotes.productSearch.value"
                                            @focus="quotes.showProductResults.value = true"
                                            @blur="quotes.BlurSetTime()"
                                            type="text" 
                                            placeholder="Escribe para buscar..." 
                                            class="w-full p-3 pl-10 rounded-xl bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 outline-none focus:border-primary shadow-sm dark:text-white text-sm">
                                        
                                        <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400"></i>
                                    </div>
                                    
                                    <!-- Resultados Productos -->
                                    <div v-if="quotes.showProductResults.value" class="absolute top-full left-0 right-0 mt-2 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-700 max-h-[50vh] md:max-h-[60vh] overflow-y-auto overflow-x-hidden z-40">
                                        <div v-for="prod in quotes.filteredProducts.value" :key="prod._id" @click="quotes.addProduct(prod)" class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-transparent hover:border-primary transition flex justify-between items-center group">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-bold text-sm dark:text-white group-hover:text-primary transition truncate">{{ prod.name }}</p>
                                                <p class="text-xs text-slate-500">${{ prod.price.toFixed(2) }}</p>
                                            </div>
                                            <i class="fa-solid fa-plus text-slate-300 group-hover:text-primary flex-shrink-0 ml-2"></i>
                                        </div>
                                        <div v-if="quotes.filteredProducts.value.length === 0" class="text-center text-xs text-slate-400 py-4">
                                            No se encontraron productos
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- BUSCADOR CLIENTE CON AUTOCOMPLETE -->
                                <div class="relative">
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</label>
                                    <div class="relative">
                                        <input 
                                            v-model="quotes.clientSearch.value" 
                                            @focus="quotes.showClientResults.value = true"
                                            @blur="quotes.BlurSetTime()"
                                            type="text" 
                                            class="w-full p-3 pl-10 rounded-xl border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary text-sm" 
                                            placeholder="Buscar usuario...">
                                        <i class="fa-solid fa-user absolute left-3 top-3.5 text-slate-400"></i>
                                        
                                        <!-- Resultados Autocomplete -->
                                        <ul v-if="quotes.showClientResults.value && quotes.filteredClients.value.length > 0" class="absolute z-50 w-full bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto thin-scroll left-0 right-0">
                                            <li v-for="user in quotes.filteredClients.value" :key="user._id" @click="quotes.selectClient(user)" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-b dark:border-slate-700 last:border-0">
                                                <p class="font-bold text-sm dark:text-white truncate">{{ user.name }}</p>
                                                <p class="text-xs text-slate-500">{{ user.phone }}</p>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Sucursal</label>
                                        <input v-model="quotes.form.branch" type="text" class="w-full p-3 rounded-xl border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Válido Hasta</label>
                                        <input v-model="quotes.form.validUntil" type="date" class="w-full p-3 rounded-xl border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none text-sm">
                                    </div>
                                </div>

                                <div>
                                    <button @click="openDiscountModal" class="w-full h-28 md:h-32 bg-slate-50 dark:bg-slate-700 rounded-2xl shadow-sm border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-red-500 hover:shadow-md transition flex flex-col items-center justify-center gap-2 group">
                                        <div class="w-10 md:w-12 h-10 md:h-12 rounded-full bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center text-lg md:text-xl group-hover:scale-110 transition">
                                            <i class="fa-solid fa-tag"></i>
                                        </div>
                                        <span class="font-bold text-sm md:text-base text-slate-700 dark:text-slate-200">Aplicar Descuento</span>
                                    </button>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Notas</label>
                                    <textarea v-model="quotes.form.notes" rows="2" class="w-full p-3 rounded-xl border dark:border-slate-600 dark:bg-slate-700 dark:text-white outline-none text-sm resize-none" placeholder="Notas visibles..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Panel Derecho: Lista de Items -->
                        <div class="w-full lg:w-2/3 bg-white dark:bg-slate-800 flex flex-col overflow-hidden order-1 lg:order-2">
                            <!-- Tabla Items -->
                            <div class="flex-1 overflow-y-auto p-4 md:p-6">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left min-w-full">
                                        <thead class="text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900 uppercase text-xs sticky top-0 z-10">
                                            <tr>
                                                <th class="p-3 rounded-l-lg">Producto</th>
                                                <th class="p-3 text-center whitespace-nowrap">Cant.</th>
                                                <th class="p-3 text-right whitespace-nowrap">Precio</th>
                                                <th class="p-3 text-right whitespace-nowrap">Total</th>
                                                <th class="p-3 rounded-r-lg text-center"></th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                            <tr v-for="(item, idx) in quotes.form.items" :key="item._id" class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                                                <td class="p-3 font-bold dark:text-white truncate max-w-xs">{{ item.name }}</td>
                                                <td class="p-3">
                                                    <div class="flex items-center justify-center gap-1 md:gap-2 flex-nowrap">
                                                        <button @click="quotes.updateQty(idx, -1)" class="w-6 h-6 rounded bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-minus text-xs"></i></button>
                                                        <span class="font-bold w-6 text-center dark:text-white text-sm">{{ item.qty }}</span>
                                                        <button @click="quotes.updateQty(idx, 1)" class="w-6 h-6 rounded bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-plus text-xs"></i></button>
                                                    </div>
                                                </td>
                                                <td class="p-3 text-right dark:text-slate-300 whitespace-nowrap">${{ item.price.toFixed(2) }}</td>
                                                <td class="p-3 text-right font-bold dark:text-white whitespace-nowrap">${{ (item.price * item.qty).toFixed(2) }}</td>
                                                <td class="p-3 text-center">
                                                    <button @click="quotes.removeItem(idx)" class="text-red-400 hover:text-red-600 transition flex-shrink-0"><i class="fa-solid fa-times"></i></button>
                                                </td>
                                            </tr>
                                            <tr v-if="quotes.form.items.length === 0">
                                                <td colspan="5" class="p-8 md:p-12 text-center text-slate-300 text-base md:text-lg">La cotización está vacía</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Totales y Acciones -->
                            <div class="p-4 md:p-6 bg-slate-50 dark:bg-slate-900 border-t dark:border-slate-700 space-y-4">
                                <!-- Resumen Financiero -->
                                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-sm">
                                    <div class="space-y-2 text-sm mb-4">
                                        <div class="flex justify-between text-slate-600 dark:text-slate-400">
                                            <span>Subtotal</span>
                                            <span class="font-medium">${{ quotes.totals.value.subtotal.toFixed(2) }}</span>
                                        </div>
                                        <div class="flex justify-between text-slate-600 dark:text-slate-400" v-if="settings.iva > 0">
                                            <span>IVA ({{ settings.iva }}%)</span>
                                            <span class="font-medium">${{ quotes.totals.value.tax.toFixed(2) }}</span>
                                        </div>
                                        <div v-if="quotes.totals.value.discount > 0" class="flex justify-between text-red-500">
                                            <span class="truncate">Desc. {{ quotes.form.discount.title ? `(${quotes.form.discount.title})` : '' }}</span>
                                            <span class="font-bold flex-shrink-0 ml-2">-${{ quotes.totals.value.discount.toFixed(2) }}</span>
                                        </div>
                                        <div class="flex justify-between text-slate-600 dark:text-slate-400 border-t dark:border-slate-700 pt-2">
                                            <span class="font-bold text-slate-900 dark:text-white">Total</span>
                                            <span class="font-bold text-lg text-slate-900 dark:text-white">${{ quotes.totals.value.total.toFixed(2) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de Acción -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                                    <button @click="quotes.generatePDF" class="py-2 md:py-3 px-2 md:px-4 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-lg md:rounded-xl font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition text-xs md:text-sm flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap">
                                        <i class="fa-solid fa-file-pdf"></i> <span class="hidden md:inline">PDF</span>
                                    </button>
                                    <button @click="openQuoteShare('wa')" class="py-2 md:py-3 px-2 md:px-4 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-lg md:rounded-xl font-bold text-green-500 hover:bg-green-50 dark:hover:bg-green-900/20 transition text-xs md:text-sm flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap">
                                        <i class="fa-brands fa-whatsapp"></i> <span class="hidden md:inline">WhatsApp</span>
                                    </button>
                                    <button @click="quotes.sendEmail" class="py-2 md:py-3 px-2 md:px-4 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded-lg md:rounded-xl font-bold text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition text-xs md:text-sm flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap">
                                        <i class="fa-solid fa-envelope"></i> <span class="hidden md:inline">Email</span>
                                    </button>
                                    <button v-if="quotes.form.status != 'ready'" @click="convertQuoteToSale" class="py-2 md:py-3 px-2 md:px-4 bg-indigo-600 text-white rounded-lg md:rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition text-xs md:text-sm flex items-center justify-center gap-1 md:gap-2 whitespace-nowrap col-span-2 md:col-span-1">
                                        <i class="fa-solid fa-cash-register"></i> <span class="">Convertir</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW FINANZAS / CAJA -->
                <div v-if="currentView === 'finance'" class="animate-fade-in space-y-6">
                    
                    <!-- Header -->
                    <div class="lg:flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Control de Caja</h2>
                            <p class="text-slate-500 dark:text-slate-400">Gestión de flujo de efectivo y cortes</p>
                        </div>
                        <div class="flex gap-3 lg:mt-4">
                            <button @click="finance.fetchCurrentStatus" class="w-10 h-10 hidden md:inline rounded-full bg-white dark:bg-slate-800 shadow text-slate-500 hover:text-primary transition flex items-center justify-center"><i class="fa-solid fa-rotate"></i></button>
                            <button v-if="finance.shiftStatus.value === 'closed'" @click="finance.showOpenModal.value = true" class="hidden md:inline bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-emerald-500/30 font-bold transition">
                                <i class="fa-solid fa-lock-open lg:mr-2"></i> <span> Abrir Caja</span>
                            </button>
                            <button v-if="finance.shiftStatus.value === 'open'" @click="closeFinanceShift()" class="hidden md:inline bg-red-500 hover:bg-red-600 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-red-500/30 font-bold transition">
                                <i class="fa-solid fa-lock lg:mr-2"></i> <span> Cerrar Caja (Corte)</span>
                            </button>
                        </div>
                    </div>

                    <!-- ESTADO: CAJA CERRADA -->
                    <div v-if="finance.shiftStatus.value === 'closed'" class="bg-slate-100 dark:bg-slate-800 rounded-3xl p-12 text-center border-2 border-dashed border-slate-300 dark:border-slate-700">
                        <div class="w-24 h-24 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-400 text-4xl">
                            <i class="fa-solid fa-store-slash"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-700 dark:text-white mb-2">La caja está cerrada</h3>
                        <p class="text-slate-500 mb-8">Debes realizar la apertura de caja para comenzar a registrar ventas y movimientos.</p>
                        <button @click="finance.showOpenModal.value = true" class="bg-primary text-white px-8 py-3 rounded-xl font-bold hover:bg-primaryDark transition shadow-xl">
                            Realizar Apertura Ahora
                        </button>
                    </div>

                    <!-- ESTADO: CAJA ABIERTA (DASHBOARD) -->
                    <div v-if="finance.shiftStatus.value === 'open' && finance.currentData.value" class="space-y-6">
                        
                        <!-- Tarjetas Superiores -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Efectivo en Caja (IMPORTANTE) -->
                            <div class="bg-emerald-500 text-white p-6 rounded-2xl shadow-lg shadow-emerald-500/20 relative overflow-hidden group">
                                <div class="absolute right-[-10px] top-[-10px] text-emerald-400 opacity-30 text-8xl group-hover:scale-110 transition"><i class="fa-solid fa-wallet"></i></div>
                                <p class="text-emerald-100 text-sm font-bold uppercase mb-1">Efectivo en Caja</p>
                                <h3 class="text-3xl font-black">${{ finance.currentData.value.currentCashInDrawer.toFixed(2) }}</h3>
                                <p class="text-xs text-emerald-100 mt-2 opacity-80">Incluye fondo inicial y movimientos</p>
                            </div>

                            <!-- Ventas Tarjetas Credito -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-regular fa-credit-card"></i></div>
                                    <span class="text-slate-500 text-sm font-bold">Tarjetas Crédito</span>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800 dark:text-white">${{ finance.currentData.value.salesSummary.credit_card.toFixed(2) }}</h3>
                            </div>

                            <!-- Ventas Tarjetas Debito -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-credit-card"></i></div>
                                    <span class="text-slate-500 text-sm font-bold">Tarjetas Dédito</span>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800 dark:text-white">${{ finance.currentData.value.salesSummary.debit_card.toFixed(2) }}</h3>
                            </div>

                            <!-- Total Ventas -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-8 h-8 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center"><i class="fa-solid fa-cash-register"></i></div>
                                    <span class="text-slate-500 text-sm font-bold">Ventas Totales</span>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-800 dark:text-white">${{ finance.currentData.value.salesSummary.total.toFixed(2) }}</h3>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Columna Izquierda: Acciones y Resumen -->
                            <div class="space-y-6">
                                <!-- Botones Acción Rápida -->
                                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <h4 class="font-bold text-slate-800 dark:text-white mb-4">Movimientos de Caja</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <button @click="finance.movementForm.type = 'in'; finance.showMovementModal.value = true" class="flex flex-col items-center justify-center p-4 rounded-xl bg-green-50 hover:bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-400 transition border border-transparent hover:border-green-200">
                                            <i class="fa-solid fa-arrow-down mb-2 text-xl"></i>
                                            <span class="font-bold text-sm">Ingreso / Depósito</span>
                                        </button>
                                        <button @click="finance.movementForm.type = 'out'; finance.showMovementModal.value = true" class="flex flex-col items-center justify-center p-4 rounded-xl bg-red-50 hover:bg-red-100 text-red-700 dark:bg-red-900/20 dark:text-red-400 transition border border-transparent hover:border-red-200">
                                            <i class="fa-solid fa-arrow-up mb-2 text-xl"></i>
                                            <span class="font-bold text-sm">Retiro / Gasto</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Info Caja -->
                                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-6 rounded-2xl border border-indigo-100 dark:border-indigo-800/50">
                                    <h4 class="font-bold text-indigo-900 dark:text-indigo-200 mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-info"></i> Info del Turno</h4>
                                    <ul class="space-y-3 text-sm">
                                        <li class="flex justify-between">
                                            <span class="text-slate-500 dark:text-slate-400">Apertura:</span>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">{{ new Date(finance.currentData.value.shift.startTime).toLocaleString() }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-slate-500 dark:text-slate-400">Fondo Inicial:</span>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">${{ finance.currentData.value.shift.initialCash.toFixed(2) }}</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="text-slate-500 dark:text-slate-400">Responsable:</span>
                                            <span class="font-bold text-slate-700 dark:text-slate-300">Admin</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Columna Derecha: Tabla Movimientos -->
                            <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col overflow-hidden">
                                <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                                    <h4 class="font-bold text-slate-800 dark:text-white">Bitácora de Movimientos</h4>
                                </div>
                                <div class="flex-1 overflow-auto max-h-[400px]">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 sticky top-0">
                                            <tr>
                                                <th class="p-4 font-bold">Tipo</th>
                                                <th class="p-4 font-bold">Monto</th>
                                                <th class="p-4 font-bold">Motivo</th>
                                                <th class="p-4 font-bold">Hora</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                            <tr v-if="finance.currentData.value.shift.movements.length === 0">
                                                <td colspan="4" class="p-8 text-center text-slate-400">Sin movimientos manuales registrados</td>
                                            </tr>
                                            <tr v-for="(mov, idx) in finance.currentData.value.shift.movements.slice().reverse()" :key="idx" class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                                <td class="p-4">
                                                    <span class="px-2 py-1 rounded text-xs font-bold uppercase" 
                                                        :class="mov.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                                        {{ mov.type === 'in' ? 'Ingreso' : 'Retiro' }}
                                                    </span>
                                                </td>
                                                <td class="p-4 font-bold text-slate-800 dark:text-white">${{ mov.amount.toFixed(2) }}</td>
                                                <td class="p-4 text-slate-600 dark:text-slate-300">{{ mov.reason }}</td>
                                                <td class="p-4 text-slate-400 text-xs">{{ new Date(mov.date).toLocaleTimeString() }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- HISTORIAL DE CORTES (SIEMPRE VISIBLE) -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 mt-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white">Historial de Cortes</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-slate-500 bg-slate-50 dark:bg-slate-900 uppercase text-xs">
                                    <tr>
                                        <th class="p-3">Fecha Cierre</th>
                                        <th class="p-3">Responsable</th>
                                        <th class="p-3">Ventas Totales</th>
                                        <th class="p-3">Efectivo Esperado</th>
                                        <th class="p-3">Efectivo Real</th>
                                        <th class="p-3">Diferencia</th>
                                        <th class="p-3 text-right">Acción</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <tr v-for="h in finance.historyList.value" :key="h._id" class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="p-3">{{ new Date(h.endTime).toLocaleString() }}</td>
                                        <td class="p-3">{{ h.closedBy ? h.closedBy.username : 'Admin' }}</td>
                                        <td class="p-3 font-bold text-slate-800 dark:text-white">-</td> <!-- Calcular si es necesario -->
                                        <td class="p-3">${{ h.finalCashExpected.toFixed(2) }}</td>
                                        <td class="p-3 font-bold">${{ h.finalCashActual.toFixed(2) }}</td>
                                        <td class="p-3">
                                            <span class="font-bold" :class="h.difference >= 0 ? 'text-green-500' : 'text-red-500'">
                                                {{ h.difference >= 0 ? '+' : '' }}{{ h.difference.toFixed(2) }}
                                            </span>
                                        </td>
                                        <td class="p-3 text-right">
                                            <button class="text-primary hover:text-primaryDark"><i class="fa-solid fa-print"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- VIEW LISTADO DE USUARIOS -->
                <div v-if="currentView === 'users'" class="space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Base de Usuarios</h2>
                            <p class="text-slate-500 dark:text-slate-400">Clientes registrados en lealtad</p>
                        </div>
                        <button class="bg-primary hover:bg-primaryDark text-white px-6 py-2.5 rounded-xl shadow-lg transition">
                            <i class="fa-solid fa-file-export mr-2"></i> Exportar
                        </button>
                    </div>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden p-4">
                        <table id="usersTable" class="w-full text-left display responsive nowrap" style="width:100%">
                            <thead class="bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs uppercase">
                                <tr>
                                    <th>Cliente</th>
                                    <th>Teléfono</th>
                                    <th>Puntos</th>
                                    <th>Visitas</th>
                                    <th>Última Visita</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW DETALLE DE USUARIO (CRM) -->
                <div v-if="currentView === 'user_details'" class="animate-fade-in pb-10">
                    <!-- Header Navegación -->
                    <div class="flex items-center gap-4 mb-6">
                        <button @click="currentView = 'users'" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                            <i class="fa-solid fa-arrow-left text-slate-500 dark:text-slate-300"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                {{ users.selectedUser.value?.name }}
                                <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold uppercase">Activo</span>
                            </h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">ID: {{ users.selectedUser.value?._id }}</p>
                        </div>
                    </div>

                    <div v-if="users.isLoadingDetails.value" class="h-64 flex items-center justify-center">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary"></i>
                    </div>

                    <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <!-- COLUMNA IZQUIERDA: ESTADÍSTICAS Y VENTAS -->
                        <div class="lg:col-span-2 space-y-6">
                            
                            <!-- KPIs del Usuario -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <div class="flex items-center gap-3 mb-1">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-bag-shopping"></i></div>
                                        <span class="text-sm text-slate-500 font-medium">Compras</span>
                                    </div>
                                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ users.selectedUserStats.value?.totalOrders || 0 }}</p>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <div class="flex items-center gap-3 mb-1">
                                        <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-mobile-screen"></i></div>
                                        <span class="text-sm text-slate-500 font-medium">Visitas App</span>
                                    </div>
                                    <p class="text-2xl font-black text-slate-800 dark:text-white">{{ users.selectedUserStats.value?.totalVisits || 0 }}</p>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <div class="flex items-center gap-3 mb-1">
                                        <div class="w-8 h-8 rounded-lg bg-green-50 text-green-600 flex items-center justify-center"><i class="fa-solid fa-money-bill-wave"></i></div>
                                        <span class="text-sm text-slate-500 font-medium">Gasto Total</span>
                                    </div>
                                    <p class="text-2xl font-black text-slate-800 dark:text-white">${{ (users.selectedUserStats.value?.totalSpent || 0).toFixed(2) }}</p>
                                </div>
                            </div>

                            <!-- Historial Últimas Compras -->
                            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                                    <h3 class="font-bold text-lg text-slate-800 dark:text-white">Últimas Compras</h3>
                                    <button class="text-sm text-primary hover:underline">Ver todas</button>
                                </div>
                                <div v-if="users.selectedUserOrders.value.length === 0" class="p-8 text-center text-slate-400">
                                    <i class="fa-solid fa-receipt text-3xl mb-2 opacity-50"></i>
                                    <p>Este usuario aún no ha realizado compras.</p>
                                </div>
                                <div v-else class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <div v-for="order in users.selectedUserOrders.value" :key="order._id" class="p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition flex justify-between items-center">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500">
                                                <i class="fa-solid fa-bag-shopping"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-800 dark:text-white text-sm">Orden #{{ order._id.slice(-6).toUpperCase() }}</p>
                                                <p class="text-xs text-slate-500">
                                                    {{ new Date(order.createdAt).toLocaleDateString() }} • {{ new Date(order.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-slate-800 dark:text-white">${{ order.total.toFixed(2) }}</p>
                                            <span class="text-[10px] px-2 py-0.5 rounded bg-green-100 text-green-700 uppercase font-bold">{{ order.status }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA DERECHA: PERFIL -->
                        <div class="space-y-6">
                            
                            <!-- Datos Básicos -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-id-card text-slate-400"></i> Datos Básicos
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500 text-lg font-bold">
                                            {{ users.selectedUser.value?.name[0] }}
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold text-slate-800 dark:text-white">{{ users.selectedUser.value?.name }}</p>
                                            <p class="text-xs text-slate-500">Cliente Lealtad</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400 uppercase font-bold">Teléfono / ID</label>
                                        <p class="text-sm font-medium text-slate-800 dark:text-white flex items-center gap-2">
                                            {{ users.selectedUser.value?.phone }}
                                            <button @click="copyToClipboard(users.selectedUser.value?.phone)" class="text-slate-400 hover:text-primary"><i class="fa-regular fa-copy"></i></button>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-400 uppercase font-bold">Puntos Actuales</label>
                                        <p class="text-sm font-medium text-emerald-600 font-bold">{{ users.selectedUser.value?.points }} pts</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Datos de Facturación (Placeholder) -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 opacity-70">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        <i class="fa-solid fa-file-invoice-dollar text-slate-400"></i> Facturación
                                    </h3>
                                    <span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded font-bold">PRÓXIMAMENTE</span>
                                </div>
                                <p class="text-sm text-slate-500 italic">Aquí podrás gestionar los datos fiscales del cliente para facturación automática.</p>
                            </div>

                            <!-- Comentarios / Notas Internas -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                                <h3 class="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-comment-dots text-slate-400"></i> Notas Internas
                                </h3>
                                <textarea rows="4" placeholder="Escribe notas sobre el cliente (alergias, preferencias, etc)..." class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 text-sm focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none"></textarea>
                                <button class="mt-2 w-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">Guardar Nota</button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- CONFIGURACIÓN VIEW -->
                <div v-if="currentView === 'settings'" class="space-y-4 md:space-y-6 animate-fade-in mx-auto px-0 md:px-0 max-w-4xl">
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white px-4 md:px-0">Configuración del Sistema</h2>
                    
                    <!-- TARJETA 1: IDENTIDAD VISUAL -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div class="w-full sm:w-auto">
                                <h3 class="font-bold text-base md:text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                    <i class="fa-solid fa-store text-primary text-base md:text-lg"></i> 
                                    <span class="truncate">{{ settings.role === 'superadmin' ? 'Plataforma SaaS' : 'Mi Negocio' }}</span>
                                </h3>
                                <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400 mt-1">Personaliza la identidad visual e información.</p>
                            </div>
                            <div class="w-full sm:w-auto">
                                <button @click="openPWA()" type="button" class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs md:text-sm px-3 md:px-4 py-2 md:py-2.5 rounded-xl shadow-lg shadow-emerald-500/30 font-bold transition inline-flex items-center justify-center w-full sm:w-auto gap-2 cursor-pointer border-none">
                                    <i class="fa-solid fa-share text-sm md:text-base"></i>
                                    <span>Abrir mi App Web</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4 md:p-6">
                            <div class="flex flex-col gap-6 md:gap-8">
                                <!-- LOGO SECTION -->
                                <div v-if="settings.role === 'admin_negocio'" class="flex flex-col sm:flex-row items-center sm:items-start gap-6 pb-6 sm:pb-0 sm:border-b border-slate-100 dark:border-slate-700">
                                    <div class="flex flex-col items-center space-y-3 w-full sm:w-auto">
                                        <label class="text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300">Logo del Negocio</label>
                                        <div class="relative group cursor-pointer w-28 h-28 md:w-32 md:h-32 flex-shrink-0">
                                            <input type="file" ref="avatarInput" @change="uploadAvatar" class="hidden" accept="image/*">
                                            <div @click="$refs.avatarInput.click()" class="w-full h-full rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-600 flex items-center justify-center overflow-hidden hover:border-primary hover:bg-slate-50 dark:hover:bg-slate-700 transition relative bg-slate-50 dark:bg-slate-800 shadow-sm">
                                                <img v-if="settings.avatar" :src="settings.avatar" class="w-full h-full object-cover">
                                                <div v-else class="text-slate-400 flex flex-col items-center text-center p-2">
                                                    <i class="fa-regular fa-image text-2xl md:text-3xl mb-1"></i>
                                                    <span class="text-[9px] md:text-[10px] font-medium uppercase">Subir Logo</span>
                                                </div>
                                                <div v-if="isUploadingAvatar" class="absolute inset-0 bg-white/80 dark:bg-black/60 flex items-center justify-center z-10">
                                                    <i class="fa-solid fa-circle-notch fa-spin text-primary text-lg md:text-xl"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- FORMULARIO CAMPOS -->
                                    <div class="flex-1 space-y-4 w-full">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                                    {{ settings.role === 'superadmin' ? 'Nombre Plataforma' : 'Nombre del Negocio' }}
                                                </label>
                                                <input v-model="settings.appName" type="text" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                            </div>
                                            <div v-if="settings.role === 'admin_negocio'">
                                                <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                                    Slug <small class="text-[10px]">(URL de tu WebApp)</small>
                                                </label>
                                                <input v-model="settings.slug" type="text" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                            </div>
                                            <div v-if="settings.role === 'admin_negocio'">
                                                <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                                    Dirección Fisica
                                                </label>
                                                <input v-model="settings.address" type="text" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RESTO DE CAMPOS (sin logo) -->
                                <div v-else class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                                                {{ settings.role === 'superadmin' ? 'Nombre Plataforma' : 'Nombre del Negocio' }}
                                            </label>
                                            <input v-model="settings.appName" type="text" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        </div>
                                    </div>
                                </div>

                                <!-- CAMPOS ADICIONALES ADMIN -->
                                <div v-if="settings.role === 'admin_negocio'" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Teléfono / WhatsApp</label>
                                            <input v-model="settings.phone" type="tel" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Correo de Contacto</label>
                                            <input v-model="settings.ownerEmail" type="email" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Color Principal</label>
                                            <div class="flex gap-2 items-center">
                                                <div class="relative overflow-hidden w-10 h-10 flex-shrink-0 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm">
                                                    <input v-model="settings.primaryColor" type="color" class="absolute -top-2 -left-2 w-16 h-16 cursor-pointer border-none p-0">
                                                </div>
                                                <input v-model="settings.primaryColor" type="text" class="flex-1 px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary uppercase font-mono">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tarjeta Categorías -->
                                    <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-100 dark:border-slate-700">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-bold text-lg flex items-center gap-2 dark:text-white">
                                                <i class="fa-solid fa-tags text-brand"></i> Categorías
                                            </h3>
                                            <span class="text-xs font-bold bg-brand/10 text-brand px-2 py-1 rounded-lg">{{ settings.categories.length }} seleccionadas</span>
                                        </div>
                                        
                                        <p class="text-sm text-slate-500 mb-4">Selecciona todas las categorías que describan tu menú. Esto ayuda a que te encuentren en el buscador.</p>

                                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 max-h-60 overflow-y-auto thin-scroll pr-1">
                                            <div v-for="avilcts in availableCategories" :key="avilcts.id" 
                                                @click="toggleCategory(avilcts.id)"
                                                class="category-card cursor-pointer border border-slate-200 dark:border-slate-600 rounded-2xl p-3 flex flex-col items-center justify-center gap-2 text-center hover:bg-slate-50 dark:hover:bg-slate-700 transition"
                                                :class="{'category-selected': settings.categories.includes(avilcts.id)}">
                                                <span class="text-2xl">{{ avilcts.emoji }}</span>
                                                <span class="text-[11px] font-bold leading-tight">{{ avilcts.name }}</span>
                                            </div>
                                        </div>
                                        <p v-if="settings.categories.length === 0" class="text-red-500 text-xs mt-2 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> Debes seleccionar al menos una.</p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 mt-6 pt-4 gap-4 border-t">
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Moneda</label>
                                            <select v-model="settings.currency" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary cursor-pointer">
                                                <option value="" disabled selected>Selecciona una moneda</option>
                                                <option value="MXN">Pesos Mexicanos (MXN)</option>
                                                <!--<option value="USD">Dólares (USD)</option>-->
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">IVA %</label>
                                            <input v-model="settings.iva" type="number" placeholder="% de IVA para cada operación" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                        </div>
                                    </div>
                                </div>

                                <!-- BOTÓN GUARDAR -->
                                <div class="flex flex-col-reverse sm:flex-row gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                                    <button @click="saveSettings" class="w-full sm:w-auto bg-primary hover:bg-primaryDark text-white px-4 md:px-6 py-2.5 rounded-xl font-medium transition shadow-md flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-save text-sm md:text-base"></i>
                                        <span class="text-sm md:text-base">Guardar Cambios</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TARJETA 2: ACCESO -->
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 md:p-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold text-base md:text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved text-secondary text-base md:text-lg"></i>
                                <span>Acceso</span>
                            </h3>
                        </div>
                        <div class="p-4 md:p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Usuario</label>
                                    <input v-model="profile.username" type="text" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                <div>
                                    <label class="block text-xs md:text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nueva Contraseña</label>
                                    <input v-model="profile.newPassword" type="password" placeholder="Dejar en blanco para no cambiar" class="w-full px-3 md:px-4 py-2 text-sm md:text-base border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <div class="flex flex-col-reverse sm:flex-row gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <button @click="saveProfile" class="w-full sm:w-auto bg-slate-800 hover:bg-black dark:bg-slate-700 dark:hover:bg-slate-600 text-white px-4 md:px-6 py-2.5 rounded-xl font-medium transition shadow-md text-sm md:text-base">
                                    Actualizar Perfil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===================== NUEVA VISTA KDS (COCINA) ===================== -->
                <div v-if="currentView === 'kds'" class="h-full flex flex-col animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold dark:text-white flex items-center gap-2">
                            <i class="fa-solid fa-fire-burner text-orange-500"></i> Cocina (KDS)
                        </h2>
                        <div class="flex gap-2 text-sm">
                            <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full font-bold">Pendientes: {{ kds.pendingOrders.value.length }}</span>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-bold">Prep: {{ kds.preparingOrders.value.length }}</span>
                        </div>
                    </div>
                    
                    <!-- TABLERO KDS -->
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4 overflow-hidden">
                        
                        <!-- COLUMNA 1: PENDIENTES -->
                        <div class="flex flex-col bg-slate-200 dark:bg-slate-800 rounded-2xl p-2 border-t-4 border-amber-500">
                            <div class="text-center font-bold text-slate-500 uppercase text-xs mb-2 tracking-wider">Pendientes</div>
                            <div class="flex-1 overflow-y-auto max-h-[65vh] space-y-3 thin-scroll px-1 pb-10">
                                <div v-for="order in kds.pendingOrders.value" :key="order._id" class="kds-card bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm border-l-4 border-amber-400 relative">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-mono font-bold text-lg dark:text-white">#{{ order._id.slice(-6).toUpperCase()}}</span>
                                        <span class="text-xs font-bold text-slate-400">{{ kds.getTimeElapsed(order.createdAt) }}</span>
                                    </div>
                                    <div class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-2 truncate">
                                        {{ order.customerId ? order.customerId.name : 'Mostrador' }}
                                    </div>
                                    
                                    <!-- ITEMS KDS (CORREGIDO: selectedOptions) -->
                                    <div class="space-y-3 mb-4">
                                        <div v-for="item in order.items" :key="item.name + item._id" class="text-sm border-b border-dashed border-slate-200 dark:border-slate-600 pb-2 last:border-0 last:pb-0">
                                            <!-- Nombre y Cantidad -->
                                            <div class="flex gap-2 items-start">
                                                <span class="font-black text-slate-800 dark:text-white bg-slate-100 dark:bg-slate-600 px-2 py-0.5 rounded text-sm">{{ item.quantity }}</span>
                                                <span class="dark:text-slate-200 font-medium leading-tight">{{ item.name }}</span>
                                            </div>
                                            
                                            <!-- Complementos (Selected Options) -->
                                            <div v-if="item.selectedOptions && item.selectedOptions.length > 0" class="pl-8 mt-1 space-y-0.5">
                                                <div v-for="opt in item.selectedOptions" :key="opt.name" class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                    <i class="fa-solid fa-plus text-[10px] opacity-60"></i> {{ opt.name }}
                                                </div>
                                            </div>

                                            <!-- Notas del Item -->
                                            <div v-if="item.note" class="pl-8 mt-1">
                                                <div class="text-xs text-white bg-red-500 px-2 py-0.5 rounded inline-block font-bold">
                                                    Nota: {{ item.note }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button @click="kds.advanceStatus(order, 'preparing')" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-lg active:scale-95 transition">
                                        Empezar <i class="fa-solid fa-fire ml-1"></i>
                                    </button>
                                </div>
                                <div v-if="kds.pendingOrders.value.length === 0" class="text-center text-slate-400 py-10 opacity-50"><i class="fa-solid fa-mug-hot text-4xl mb-2"></i><p>Sin pedidos</p></div>
                            </div>
                        </div>

                        <!-- COLUMNA 2: PREPARANDO -->
                        <div class="flex flex-col bg-slate-200 dark:bg-slate-800 rounded-2xl p-2 border-t-4 border-blue-500">
                            <div class="text-center font-bold text-slate-500 uppercase text-xs mb-2 tracking-wider">En Preparación</div>
                            <div class="flex-1 overflow-y-auto max-h-[65vh] space-y-3 thin-scroll px-1 pb-10">
                                <div v-for="order in kds.preparingOrders.value" :key="order._id" class="kds-card bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm border-l-4 border-blue-400">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-mono font-bold text-lg dark:text-white">#{{ order._id.slice(-4) }}</span>
                                        <span class="text-xs font-bold text-blue-500 animate-pulse">Preparando...</span>
                                    </div>
                                    
                                    <!-- ITEMS KDS (CORREGIDO: selectedOptions) -->
                                    <div class="space-y-3 mb-4 opacity-90">
                                        <div v-for="item in order.items" :key="item.name + item._id" class="text-sm border-b border-dashed border-slate-200 dark:border-slate-600 pb-2 last:border-0 last:pb-0">
                                            <div class="flex gap-2 items-start">
                                                <span class="font-black bg-slate-100 dark:bg-slate-600 px-2 py-0.5 rounded text-sm dark:text-white">{{ item.quantity }}</span>
                                                <span class="dark:text-slate-200 font-medium leading-tight">{{ item.name }}</span>
                                            </div>
                                            
                                            <div v-if="item.selectedOptions && item.selectedOptions.length > 0" class="pl-8 mt-1 space-y-0.5">
                                                <div v-for="opt in item.selectedOptions" :key="opt.name" class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                    <i class="fa-solid fa-plus text-[10px] opacity-60"></i> {{ opt.name }}
                                                </div>
                                            </div>

                                            <!-- Notas del Item -->
                                            <div v-if="item.note" class="pl-8 mt-1">
                                                <div class="text-xs text-white bg-red-500 px-2 py-0.5 rounded inline-block font-bold">
                                                    Nota: {{ item.note }}
                                                </div>
                                            </div>

                                            <div v-if="item.notes" class="pl-8 mt-1">
                                                <span class="text-xs text-red-500 font-bold">Nota: {{ item.notes }}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <button @click="kds.advanceStatus(order, 'ready')" class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-lg shadow-lg active:scale-95 transition">
                                        Terminar <i class="fa-solid fa-check ml-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA 3: LISTOS -->
                        <div class="flex flex-col bg-slate-200 dark:bg-slate-800 rounded-2xl p-2 border-t-4 border-emerald-500">
                            <div class="text-center font-bold text-slate-500 uppercase text-xs mb-2 tracking-wider">Listos para Entrega</div>
                            <div class="flex-1 overflow-y-auto max-h-[65vh] space-y-3 thin-scroll px-1 pb-10">
                                <div v-for="order in kds.readyOrders.value" :key="order._id" class="kds-card bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm border-l-4 border-emerald-400">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-mono font-bold text-lg dark:text-white">#{{ order._id.slice(-4) }}</span>
                                        <span class="text-xs font-bold text-emerald-600">LISTO</span>
                                    </div>
                                    <div class="text-sm text-slate-500 mb-4">{{ order.customerId ? order.customerId.name : 'Mostrador' }}</div>
                                    <button @click="kds.advanceStatus(order, 'completed')" class="w-full py-3 bg-slate-800 dark:bg-slate-900 text-white font-bold rounded-lg shadow-lg active:scale-95 transition opacity-90 hover:opacity-100">
                                        Entregar / Servir
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL ESCÁNER LEALTAD -->
    <div v-if="showScanner" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <button @click="stopScanner" class="absolute top-6 right-6 text-white bg-white/20 p-2 rounded-full z-10"><i class="fa-solid fa-xmark text-2xl"></i></button>
        <div id="reader" class="w-full max-w-md bg-white rounded-lg overflow-hidden relative"></div>
        <p class="text-white mt-8 text-sm font-medium">Apunta al código QR del cliente</p>
    </div>

    <!-- MODAL ESCÁNER products -->
    <div v-if="pos.showScannerProds.value" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in border dark:border-slate-700">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">
                    Escanear Producto
                </h3>
                <button @click="pos.stopCameraScanner" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <button @click="pos.stopCameraScanner" class="absolute top-6 right-6 text-white bg-white/20 p-2 rounded-full z-10"><i class="fa-solid fa-xmark text-2xl"></i></button>
                <div id="pos-reader" class="w-full max-w-md bg-white rounded-lg overflow-hidden relative"></div>
            </div>
        </div>
    </div>

    <!-- MODAL SAAS -->
    <div v-if="showSaasModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in border dark:border-slate-700">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ editingBusiness ? 'Editar Negocio' : 'Nuevo Cliente SaaS' }}</h3><button @click="showSaasModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nombre</label><input v-model="saasForm.businessName" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div v-if="editingBusiness"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Slug</label><input v-model="saasForm.slug" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div v-if="!editingBusiness"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Usuario <small>(Datos de ingreso)</small> </label><input v-model="saasForm.username" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div v-if="!editingBusiness"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email</label><input v-model="saasForm.ownerEmail" type="mail" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div v-if="!editingBusiness"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Pass</label><input v-model="saasForm.password" type="password" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Plan</label><select v-model="saasForm.plan" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="free">Gratis</option><option value="pro">Pro</option></select></div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-700/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3"><button @click="showSaasModal = false" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 rounded-lg">Cancelar</button><button @click="saveBusiness" class="px-4 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primaryDark">{{ editingBusiness ? 'Guardar' : 'Crear' }}</button></div>
        </div>
    </div>

    <!-- MODAL PAGO POS -->
    <div v-if="pos.showPayModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-3 sm:p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full h-auto max-h-[90vh] sm:max-h-screen max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col lg:flex-row overflow-y-auto sm:overflow-y-visible">
            <!-- Métodos -->
            <div class="w-full lg:w-1/3 bg-slate-100 dark:bg-slate-800 p-3 sm:p-4 lg:border-r dark:border-slate-700 space-y-2 lg:max-h-screen lg:overflow-y-auto">
                <h3 class="font-bold text-slate-500 mb-3 sm:mb-4 uppercase text-xs">Método de Pago</h3>
                
                <!-- EFECTIVO -->
                <button @click="pos.setPaymentMethod('cash')" 
                        class="w-full p-3 sm:p-4 rounded-xl flex items-center gap-2 sm:gap-3 transition text-sm sm:text-base" 
                        :class="pos.paymentForm.method === 'cash' ? 'bg-green-500 text-white shadow-lg' : 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200'">
                    <i class="fa-solid fa-money-bill-wave text-lg sm:text-xl w-5 sm:w-6 text-center shrink-0"></i> 
                    <span class="font-bold">Efectivo</span>
                </button>
                
                <!-- T. CRÉDITO -->
                <button @click="pos.setPaymentMethod('credit_card')" 
                        class="w-full p-3 sm:p-4 rounded-xl flex items-center gap-2 sm:gap-3 transition text-sm sm:text-base" 
                        :class="pos.paymentForm.method === 'credit_card' ? 'bg-indigo-500 text-white shadow-lg' : 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200'">
                    <i class="fa-regular fa-credit-card text-lg sm:text-xl w-5 sm:w-6 text-center shrink-0"></i> 
                    <span class="font-bold">T. Crédito</span>
                </button>

                <!-- T. DÉBITO -->
                <button @click="pos.setPaymentMethod('debit_card')" 
                        class="w-full p-3 sm:p-4 rounded-xl flex items-center gap-2 sm:gap-3 transition text-sm sm:text-base" 
                        :class="pos.paymentForm.method === 'debit_card' ? 'bg-blue-500 text-white shadow-lg' : 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200'">
                    <i class="fa-solid fa-credit-card text-lg sm:text-xl w-5 sm:w-6 text-center shrink-0"></i> 
                    <span class="font-bold">T. Débito</span>
                </button>
                
                <!-- TRANSFERENCIA -->
                <button @click="pos.setPaymentMethod('transfer')" 
                        class="w-full p-3 sm:p-4 rounded-xl flex items-center gap-2 sm:gap-3 transition text-sm sm:text-base" 
                        :class="pos.paymentForm.method === 'transfer' ? 'bg-purple-500 text-white shadow-lg' : 'bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-200'">
                    <i class="fa-solid fa-money-bill-transfer text-lg sm:text-xl w-5 sm:w-6 text-center shrink-0"></i> 
                    <span class="font-bold">Transferencia</span>
                </button>
            </div>
            
            <!-- Calculadora / Detalles -->
            <div class="w-full lg:w-2/3 p-4 sm:p-6 lg:p-8 flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl sm:text-3xl lg:text-4xl font-black text-slate-800 dark:text-white mb-1 sm:mb-2 text-right">${{ pos.currentTotals.value.total.toFixed(2) }}</h2>
                    <p class="text-right text-slate-400 text-xs sm:text-sm mb-4 sm:mb-8">Total a Pagar</p>

                    <!-- VISTA: EFECTIVO -->
                    <div v-if="pos.paymentForm.method === 'cash'" class="animate-fade-in space-y-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Monto Recibido</label>
                            <input v-model.number="pos.paymentForm.amountReceived" @input="pos.calculateChange" type="number" class="w-full text-2xl sm:text-3xl lg:text-4xl font-bold p-3 sm:p-4 border rounded-xl bg-slate-50 dark:bg-slate-800 dark:border-slate-600 dark:text-white text-right focus:ring-2 focus:ring-primary outline-none">
                        </div>
                        
                        <div class="flex gap-1 sm:gap-2 justify-end flex-wrap">
                            <button @click="pos.paymentForm.amountReceived = 100; pos.calculateChange()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-200 dark:bg-slate-700 rounded text-xs sm:text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition">$100</button>
                            <button @click="pos.paymentForm.amountReceived = 200; pos.calculateChange()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-200 dark:bg-slate-700 rounded text-xs sm:text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition">$200</button>
                            <button @click="pos.paymentForm.amountReceived = 500; pos.calculateChange()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-slate-200 dark:bg-slate-700 rounded text-xs sm:text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition">$500</button>
                            <button @click="pos.paymentForm.amountReceived = pos.currentTotals.value.total; pos.calculateChange()" class="px-2 sm:px-3 py-1.5 sm:py-2 bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300 rounded text-xs sm:text-sm font-bold hover:bg-blue-200 dark:hover:bg-blue-900/50 transition">Exacto</button>
                        </div>

                        <div class="p-3 sm:p-4 bg-green-50 dark:bg-green-900/20 rounded-xl flex justify-between items-center border border-green-100 dark:border-green-800">
                            <span class="text-green-700 dark:text-green-400 font-bold text-sm sm:text-base">Cambio</span>
                            <span class="text-xl sm:text-2xl lg:text-3xl font-black text-green-600 dark:text-green-400">${{ pos.paymentForm.change.toFixed(2) }}</span>
                        </div>
                    </div>

                    <!-- VISTA: TARJETAS / TRANSFERENCIA -->
                    <div v-else class="flex flex-col items-center justify-center min-h-48 sm:min-h-64 text-slate-400 animate-fade-in py-6">
                        <i v-if="pos.paymentForm.method === 'credit_card'" class="fa-regular fa-credit-card text-4xl sm:text-5xl lg:text-6xl mb-3 sm:mb-4 text-indigo-300"></i>
                        <i v-else-if="pos.paymentForm.method === 'debit_card'" class="fa-solid fa-credit-card text-4xl sm:text-5xl lg:text-6xl mb-3 sm:mb-4 text-blue-300"></i>
                        <i v-else class="fa-solid fa-money-bill-transfer text-4xl sm:text-5xl lg:text-6xl mb-3 sm:mb-4 text-purple-300"></i>
                        
                        <p class="font-bold text-base sm:text-lg text-slate-600 dark:text-slate-300">Procesar cobro externo</p>
                        <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">Confirma que la transacción fue exitosa en la terminal.</p>
                        
                        <!-- Referencia Opcional -->
                        <input v-model="pos.paymentForm.reference" type="text" placeholder="No. de Autorización / Referencia (Opcional)" class="mt-4 sm:mt-6 w-full px-3 sm:px-4 py-2 sm:py-3 text-center rounded-lg bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 text-xs sm:text-sm dark:text-white outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mt-4 sm:mt-6">
                    <button @click="pos.showPayModal.value = false" class="px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl border border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition text-sm sm:text-base">Cancelar</button>
                    <button @click="finishSale" class="flex-1 text-white font-bold rounded-xl shadow-lg flex justify-center items-center gap-2 hover:opacity-90 transition active:scale-95 py-2.5 sm:py-3 text-sm sm:text-base"
                            :class="{
                                'bg-green-500': pos.paymentForm.method === 'cash',
                                'bg-indigo-500': pos.paymentForm.method === 'credit_card',
                                'bg-blue-500': pos.paymentForm.method === 'debit_card',
                                'bg-purple-500': pos.paymentForm.method === 'transfer'
                            }">
                        <i class="fa-solid fa-check"></i> Confirmar Pago
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL POS: BUSCAR CLIENTE -->
    <div v-if="pos.showCustomerModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in border dark:border-slate-700 flex flex-col max-h-[80vh]">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">Seleccionar Cliente</h3>
                <button @click="pos.showCustomerModal.value = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <!-- Buscador -->
            <div class="p-4 border-b border-slate-100 dark:border-slate-700">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                    <input v-model="pos.customerSearchQuery.value" type="text" placeholder="Buscar por nombre o teléfono y/o Escanea el fa-qrcode..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 dark:text-white outline-none focus:ring-2 focus:ring-primary transition">
                </div>
            </div>

            <!-- Lista -->
            <div class="flex-1 overflow-y-auto p-2">
                <div v-if="pos.customerList.value.length === 0" class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-users-slash text-3xl mb-2"></i>
                    <p>No se encontraron clientes</p>
                </div>
                
                <div v-else class="space-y-1">
                    <div v-for="cust in pos.customerList.value" :key="cust._id" 
                         @click="pos.selectCustomer(cust)"
                         class="flex items-center justify-between p-3 hover:bg-indigo-50 dark:hover:bg-slate-800 rounded-xl cursor-pointer group transition">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500 font-bold group-hover:bg-indigo-100 group-hover:text-indigo-600 transition">
                                {{ cust.name[0] }}
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 dark:text-white text-sm">{{ cust.name }}</h4>
                                <p class="text-xs text-slate-500 font-mono">{{ cust.phone }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-xs font-bold text-emerald-600 dark:text-emerald-400">{{ cust.points }} pts</span>
                            <span class="text-[10px] text-slate-400">Visitas: {{ cust.visits }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 bg-slate-50 dark:bg-slate-950 border-t border-slate-100 dark:border-slate-700 text-center">
                <p class="text-xs text-slate-400">¿Cliente nuevo? Regístralo en la App de Lealtad</p>
            </div>
        </div>
    </div>

    <!-- MODAL DESCUENTO POS -->
    <div v-if="pos.showDiscountModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden animate-fade-in border dark:border-slate-700">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Aplicar Descuento</h3>
                <button @click="pos.showDiscountModal.value = false" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <!-- 1. Segmented Control (Cantidad | Porcentaje) -->
                <div class="bg-slate-100 dark:bg-slate-700 p-1.5 rounded-xl flex">
                    <button 
                        @click="pos.discountForm.type = 'fixed'"
                        class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2"
                        :class="pos.discountForm.type === 'fixed' ? 'bg-white dark:bg-slate-600 text-slate-800 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'">
                        <i class="fa-solid fa-dollar-sign"></i> Cantidad
                    </button>
                    <button 
                        @click="pos.discountForm.type = 'percentage'"
                        class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2"
                        :class="pos.discountForm.type === 'percentage' ? 'bg-white dark:bg-slate-600 text-slate-800 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'">
                        <i class="fa-solid fa-percent"></i> Porcentaje
                    </button>
                </div>

                <!-- 2. Inputs -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">
                            {{ pos.discountForm.type === 'fixed' ? 'Monto a descontar ($)' : 'Porcentaje a descontar (%)' }}
                        </label>
                        <div class="relative">
                            <i v-if="pos.discountForm.type === 'fixed'" class="fa-solid fa-dollar-sign absolute left-4 top-5 text-slate-400"></i>
                            <i v-else class="fa-solid fa-percent absolute left-4 top-5 text-slate-400"></i>
                            <input v-model.number="pos.discountForm.value" type="number" min="0" 
                                   class="w-full pl-10 pr-4 py-3.5 text-lg font-bold border rounded-xl bg-slate-50 dark:bg-slate-900 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-primary outline-none transition">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Motivo / Título (Opcional)</label>
                        <input v-model="pos.discountForm.reason" type="text" placeholder="Ej: Cupón Viernes, Promoción..." 
                               class="w-full px-4 py-3 border rounded-xl bg-slate-50 dark:bg-slate-900 dark:border-slate-600 dark:text-white focus:ring-2 focus:ring-primary outline-none transition text-sm">
                    </div>
                </div>

                <!-- 3. Visual Preview (Total Tachado -> Nuevo Total) -->
                <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-5 border border-indigo-100 dark:border-indigo-800/50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-500 dark:text-slate-400 text-sm">Total Original</span>
                        <span class="text-slate-400 line-through font-medium">${{ pos.discountPreview.value.original.toFixed(2) }}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2 text-red-500">
                        <span class="text-sm font-bold">Descuento</span>
                        <span class="font-bold">-${{ pos.discountPreview.value.saving.toFixed(2) }}</span>
                    </div>
                    <div class="border-t border-indigo-200 dark:border-indigo-800 my-2 pt-2 flex justify-between items-center">
                        <span class="text-slate-800 dark:text-white font-bold">Nuevo Total</span>
                        <span class="text-2xl font-black text-indigo-600 dark:text-indigo-400">${{ pos.discountPreview.value.newTotal.toFixed(2) }}</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-700 flex gap-3">
                <button @click="pos.showDiscountModal.value = false" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl transition">Cancelar</button>
                <button @click="pos.applyDiscount" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/30 hover:bg-primaryDark transition active:scale-95">
                    Aplicar Descuento
                </button>
            </div>
        </div>
    </div>

    <!-- NUEVO MODAL: DESCUENTO QUOTES -->
    <div v-if="showDiscountModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-3xl w-full max-w-sm shadow-2xl transform transition-all scale-100 animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm">
                    <i class="fa-solid fa-percent"></i>
                </div>
                <h3 class="font-bold text-xl dark:text-white">Aplicar Descuento</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Configura el tipo y monto del descuento.</p>
            </div>

            <div class="space-y-4">
                <!-- Toggle Tipo -->
                <div class="bg-slate-100 dark:bg-slate-700 p-1 rounded-xl flex">
                    <button @click="tempDiscount.type = 'fixed'" class="flex-1 py-2 rounded-lg font-bold text-sm transition" :class="tempDiscount.type === 'fixed' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-400 hover:text-slate-500'">
                        <i class="fa-solid fa-dollar-sign mr-1"></i> Monto ($)
                    </button>
                    <button @click="tempDiscount.type = 'percentage'" class="flex-1 py-2 rounded-lg font-bold text-sm transition" :class="tempDiscount.type === 'percentage' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-400 hover:text-slate-500'">
                        <i class="fa-solid fa-percent mr-1"></i> Porcentaje (%)
                    </button>
                </div>

                <!-- Input Valor -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor del Descuento</label>
                    <input v-model.number="tempDiscount.value" type="number" min="0" class="w-full p-3 text-center text-xl font-black rounded-xl border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 dark:text-white outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>

                <!-- Input Título (Opcional) -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Título (Opcional)</label>
                    <input v-model="tempDiscount.title" type="text" placeholder="Ej: Promoción Verano" class="w-full p-3 rounded-xl border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 dark:text-white outline-none focus:border-blue-500">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-8">
                <button @click="showDiscountModal = false" class="py-3 text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition">Cancelar</button>
                <button @click="confirmDiscount" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div v-if="showProductModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full md:w-full max-w-2xl overflow-hidden animate-fade-in border dark:border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ editingProduct ? 'Editar' : 'Nuevo' }} Producto</h3><button @click="showProductModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Imagen del Producto</label><div class="flex flex-col md:flex-row gap-4"><div class="h-32 w-32 shrink-0 rounded-lg bg-slate-100 dark:bg-slate-700 overflow-hidden relative group border border-slate-200 dark:border-slate-600"><img v-if="productForm.image" :src="productForm.image" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-slate-400"><i class="fa-solid fa-image text-2xl"></i></div><button v-if="productForm.image" @click="productForm.image = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center"><i class="fa-solid fa-xmark text-xs"></i></button></div><div class="flex flex-col justify-center space-y-2"><button @click="showMediaSelector = !showMediaSelector" class="text-sm text-primary hover:underline font-medium text-left"><i class="fa-solid fa-images mr-1"></i> Seleccionar de librería</button><div class="relative"><input type="file" ref="productFileInput" @change="uploadProductImage" class="hidden" accept="image/*"><button @click="$refs.productFileInput.click()" class="text-sm text-secondary hover:underline font-medium text-left"><i class="fa-solid fa-cloud-arrow-up mr-1"></i> <span v-if="isUploadingProductImg">Subiendo...</span><span v-else>Subir nueva imagen</span></button></div></div></div><div v-if="showMediaSelector" class="mt-3 border rounded-lg p-2 h-40 overflow-y-auto bg-slate-50 dark:bg-slate-900 grid grid-cols-4 gap-2"><div v-for="img in mediaFiles.filter(f => !isVideo(f.name))" :key="img.name" @click="selectProductImage(img.url)" class="aspect-square rounded overflow-hidden cursor-pointer border border-transparent hover:border-primary"><img :src="img.url" class="w-full h-full object-cover"></div></div></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Código de Barras</label>
                        <div class="relative">
                            <input v-model="productForm.barcode" type="text" class="w-full pl-8 pr-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Escanear o escribir">
                            <i class="fa-solid fa-barcode absolute left-3 top-3 text-slate-400"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nombre</label>
                        <input v-model="productForm.name" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    </div>
                    <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Existencias</label><input v-model="productForm.stock" type="number" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                    <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Precio ($)</label><input v-model="productForm.price" type="number" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Descripción</label><textarea v-model="productForm.description" rows="2" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></textarea></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Categorías</label><select multiple v-model="productForm.categories" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white h-24"><option v-for="cat in categoriesList" :key="cat._id" :value="cat._id">{{ cat.name }}</option></select><p class="text-xs text-slate-400 mt-1">Mantén presionado Ctrl (Windows) o Cmd (Mac) para seleccionar varias.</p></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Complementos Ligados</label><div class="grid grid-cols-2 gap-2 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-200 dark:border-slate-600 max-h-32 overflow-y-auto"><label v-for="addon in availableAddons" :key="addon._id" class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" :value="addon._id" v-model="productForm.addons" class="rounded text-primary focus:ring-primary dark:bg-slate-700 dark:border-slate-500"><span class="text-sm text-slate-600 dark:text-slate-300">{{ addon.name }}</span></label></div></div>
                <div class="flex items-center pt-2"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" v-model="productForm.active" class="sr-only peer"><div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div><span class="ms-3 text-sm font-medium text-slate-700 dark:text-slate-300">Producto Activo</span></label></div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-700/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 mt-auto"><button @click="showProductModal = false" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg">Cancelar</button><button @click="saveProduct" class="px-5 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primaryDark">Guardar</button></div>
        </div>
    </div>

    <!-- MODAL DETALLE ITEM POS -->
    <div v-if="showItemDetailsModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm animate-fade-in">
        <div v-if="selectedCartItem" class="bg-white dark:bg-slate-800 w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden border dark:border-slate-700 flex flex-col max-h-[90vh]">
            
            <!-- Imagen Grande Header -->
            <div class="h-40 w-full bg-slate-100 dark:bg-slate-700 relative group shrink-0">
                <img :src="selectedCartItem.image || 'https://via.placeholder.com/300'" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent flex flex-col justify-end p-6">
                    <h3 class="text-2xl font-bold text-white leading-tight shadow-black drop-shadow-md">{{ selectedCartItem.name }}</h3>
                    <p class="text-slate-300 text-sm font-medium">{{ selectedCartItem.barcode || 'Sin código' }}</p>
                </div>
                <button @click="showItemDetailsModal = false" class="absolute top-4 right-4 bg-black/30 hover:bg-black/50 text-white rounded-full p-2 backdrop-blur-sm transition"><i class="fa-solid fa-xmark text-xl w-6 h-6 flex items-center justify-center"></i></button>
            </div>

            <!-- Body -->
            <div class="p-6 space-y-6 overflow-y-auto">
                
                <!-- Precio y Total (Calculado con Extras) -->
                <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl">
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Precio Final Unitario</p>
                        <p class="text-xl font-bold text-slate-800 dark:text-white">${{ selectedItemUnitPrice.toFixed(2) }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Subtotal Línea</p>
                        <p class="text-2xl font-black text-primary">${{ (selectedItemUnitPrice * selectedCartItem.qty).toFixed(2) }}</p>
                    </div>
                </div>

                <!-- COMPLEMENTOS (ADDONS) -->
                <div v-if="selectedItemAddonGroups.length > 0" class="space-y-4">
                    <div v-for="group in selectedItemAddonGroups" :key="group._id" class="border border-slate-100 dark:border-slate-700 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-slate-800 dark:text-white">{{ group.name }}</h4>
                            <span class="text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-300">
                                {{ group.maxOptions > 1 ? `Elige hasta ${group.maxOptions}` : 'Elige 1' }}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <div v-for="(opt, oIdx) in group.options" :key="oIdx" 
                                 @click="toggleAddonOption(group, opt)"
                                 class="flex items-center justify-between p-2 rounded-lg cursor-pointer transition border"
                                 :class="isOptionSelected(group, opt) ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-500/50' : 'hover:bg-slate-50 dark:hover:bg-slate-700 border-transparent'">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded flex items-center justify-center border transition"
                                         :class="isOptionSelected(group, opt) ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-slate-300 dark:border-slate-500 bg-white dark:bg-slate-800'">
                                        <i v-if="isOptionSelected(group, opt)" class="fa-solid fa-check text-xs"></i>
                                    </div>
                                    <span class="text-sm text-slate-700 dark:text-slate-200">{{ opt.name }}</span>
                                </div>
                                <span v-if="opt.priceExtra > 0" class="text-xs font-bold text-emerald-600 dark:text-emerald-400">+${{ opt.priceExtra }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-4 text-slate-400 text-sm italic bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-dashed dark:border-slate-700">
                    Sin complementos disponibles para este producto.
                </div>

                <!-- Notas del Item -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Notas / Instrucciones</label>
                    <textarea v-model="selectedCartItem.note" rows="2" placeholder="Ej: Sin cebolla, Extra caliente..." class="w-full px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-600 focus:ring-2 focus:ring-primary outline-none dark:text-white resize-none"></textarea>
                </div>

                <!-- Control Cantidad -->
                <div>
                     <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 text-center">Cantidad</label>
                    <div class="flex items-center justify-center gap-6">
                        <button @click="pos.updateQty(selectedCartItem._id, -1)" class="w-16 h-16 rounded-2xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-white text-2xl shadow-sm hover:scale-105 active:scale-95 transition flex items-center justify-center"><i class="fa-solid fa-minus"></i></button>
                        <span class="text-5xl font-black text-slate-800 dark:text-white w-20 text-center">{{ selectedCartItem.qty }}</span>
                        <button @click="pos.updateQty(selectedCartItem._id, 1)" class="w-16 h-16 rounded-2xl bg-primary text-white text-2xl shadow-lg shadow-primary/30 hover:scale-105 active:scale-95 transition flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

            </div>

            <!-- Footer Acciones -->
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 flex gap-4 bg-white dark:bg-slate-800 z-10">
                <button @click="pos.removeFromCart(selectedCartItem._id); showItemDetailsModal = false;" class="px-4 py-3 text-red-500 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 rounded-xl font-bold transition flex flex-col items-center justify-center min-w-[80px]">
                    <i class="fa-solid fa-trash-can text-lg mb-1"></i>
                    <span class="text-[10px] uppercase">Eliminar</span>
                </button>
                <button @click="showItemDetailsModal = false" class="flex-1 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold text-lg rounded-xl shadow-lg hover:opacity-90 transition active:scale-95">
                    Confirmar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL CATEGORÍAS -->
    <div v-if="showCategoryModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full md:w-full max-w-md overflow-hidden animate-fade-in border dark:border-slate-700">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ editingCategory ? 'Editar' : 'Nueva' }} Categoría</h3><button @click="showCategoryModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                        Imagen (Opcional)
                    </label>
                    <div class="flex gap-4 items-center">
                        <div class="h-20 w-20 shrink-0 rounded-lg bg-slate-100 dark:bg-slate-700 overflow-hidden relative group border border-slate-200 dark:border-slate-600">
                            <img v-if="categoryForm.image" :src="categoryForm.image" class="w-full h-full object-cover">
                                <div v-else class="w-full h-full flex items-center justify-center text-slate-400">
                                    <i class="fa-solid fa-image text-xl"></i>
                                </div>
                                <button v-if="categoryForm.image" @click="categoryForm.image = ''" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center">
                                    <i class="fa-solid fa-xmark text-[10px]"></i>
                                </button>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button @click="showMediaSelector = !showMediaSelector" class="text-xs text-primary hover:underline font-medium text-left">
                                    <i class="fa-solid fa-images mr-1"></i> De librería
                                </button>
                                <div class="relative">
                                    <input type="file" ref="categoryFileInput" @change="uploadCategoryImage" class="hidden" accept="image/*">
                                    <button @click="$refs.categoryFileInput.click()" class="text-xs text-secondary hover:underline font-medium text-left">
                                        <i class="fa-solid fa-cloud-arrow-up mr-1"></i> 
                                        <span v-if="isUploadingCatImg">Subiendo...</span>
                                        <span v-else>Subir nueva</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div v-if="showMediaSelector" class="mt-3 border rounded-lg p-2 h-32 overflow-y-auto bg-slate-50 dark:bg-slate-900 grid grid-cols-4 gap-2"><div v-for="img in mediaFiles.filter(f => !isVideo(f.name))" :key="img.name" @click="selectCategoryImage(img.url)" class="aspect-square rounded overflow-hidden cursor-pointer border border-transparent hover:border-primary"><img :src="img.url" class="w-full h-full object-cover"></div></div></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nombre</label><input v-model="categoryForm.name" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Descripción</label><textarea v-model="categoryForm.description" rows="2" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea></div>
                <div class="flex items-center pt-2"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" v-model="categoryForm.active" class="sr-only peer"><div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div><span class="ms-3 text-sm font-medium text-slate-700 dark:text-slate-300">Categoría Visible</span></label></div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-700/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3"><button @click="showCategoryModal = false" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg">Cancelar</button><button @click="saveCategory" class="px-5 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primaryDark">Guardar</button></div>
        </div>
    </div>

    <!-- MODAL COMPLEMENTOS / ADDONS -->
    <div v-if="showAddonModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full md:w-full max-w-lg overflow-hidden animate-fade-in border dark:border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ editingAddon ? 'Editar' : 'Nuevo' }} Grupo de Opciones</h3><button @click="showAddonModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nombre del Grupo</label><input v-model="addonForm.name" type="text" placeholder="Ej: Salsas, Bebidas" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Máximo a elegir</label><input v-model="addonForm.maxOptions" type="number" min="1" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></div>
                    <div class="flex items-center pt-6"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" v-model="addonForm.required" class="sr-only peer"><div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div><span class="ms-3 text-sm font-medium text-slate-700 dark:text-slate-300">¿Es Obligatorio?</span></label></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3"><label class="block text-sm font-bold text-slate-700 dark:text-slate-300">Opciones del Grupo</label><button @click="addOptionRow" class="text-xs bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1 rounded hover:bg-indigo-100 transition font-medium"><i class="fa-solid fa-plus mr-1"></i> Agregar Opción</button></div>
                    <div class="bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-600 overflow-hidden">
                        <div class="max-h-60 overflow-y-auto p-2 space-y-2">
                            <div v-for="(opt, index) in addonForm.options" :key="index" class="flex items-center gap-2">
                                <div class="flex-1"><input v-model="opt.name" type="text" placeholder="Nombre opción" class="w-full px-3 py-2 text-sm border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-500 dark:text-white focus:outline-none focus:border-primary"></div>
                                <div class="w-24"><div class="relative"><span class="absolute left-2 top-2 text-slate-400 text-sm">$</span><input v-model="opt.priceExtra" type="number" placeholder="0" class="w-full pl-6 pr-2 py-2 text-sm border rounded-lg bg-white dark:bg-slate-700 dark:border-slate-500 dark:text-white focus:outline-none focus:border-primary"></div></div>
                                <button @click="removeOptionRow(index)" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                            <div v-if="addonForm.options.length === 0" class="text-center py-4 text-slate-400 text-sm italic">Agrega opciones para que el cliente elija.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-700/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 mt-auto"><button @click="showAddonModal = false" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg">Cancelar</button><button @click="saveAddon" class="px-5 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primaryDark">Guardar Grupo</button></div>
        </div>
    </div>

    <!-- MODAL BANNERS -->
    <div v-if="showBannerModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full md:w-full max-w-lg overflow-hidden animate-fade-in border dark:border-slate-700 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-slate-800 dark:text-white">{{ editingBanner ? 'Editar' : 'Nuevo' }} Banner</h3><button @click="showBannerModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Imagen</label><div class="flex flex-col gap-3"><div v-if="bannerForm.imageUrl" class="h-40 w-full rounded-lg bg-slate-100 overflow-hidden relative group"><img :src="bannerForm.imageUrl" class="w-full h-full object-cover"><button @click="bannerForm.imageUrl = ''" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div><div v-else class="h-40 w-full rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400"><span class="text-sm">Sin imagen</span></div><div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center flex-wrap"><button @click="showMediaSelector = !showMediaSelector" class="text-sm text-primary hover:underline font-medium flex items-center"><i class="fa-solid fa-images mr-2"></i> Librería</button><div class="relative"><input type="file" ref="bannerFileInput" @change="uploadBannerImage" class="hidden" accept="image/*"><button @click="$refs.bannerFileInput.click()" class="text-sm text-secondary hover:underline font-medium flex items-center"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> <span v-if="isUploadingBanner">Subiendo...</span><span v-else>Subir nueva</span></button></div></div><div v-if="showMediaSelector" class="border rounded-lg p-2 h-40 overflow-y-auto bg-slate-50 dark:bg-slate-900 grid grid-cols-3 sm:grid-cols-4 gap-2"><div v-for="img in mediaFiles.filter(f => !isVideo(f.name))" :key="img.name" @click="selectBannerImage(img.url)" class="aspect-square rounded overflow-hidden cursor-pointer border border-transparent hover:border-primary"><img :src="img.url" class="w-full h-full object-cover"></div></div></div></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Título</label><input v-model="bannerForm.title" type="text" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Descripción</label><textarea v-model="bannerForm.description" rows="2" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></textarea></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Caducidad</label><input v-model="bannerForm.expiresAt" type="date" class="w-full px-4 py-2 border rounded-lg bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div><div class="flex items-center pt-6"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" v-model="bannerForm.active" class="sr-only peer"><div class="relative w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div><span class="ms-3 text-sm font-medium text-slate-700">Activo</span></label></div></div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-700/50 border-t border-slate-100 dark:border-slate-700 flex justify-end gap-3 mt-auto"><button @click="showBannerModal = false" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg">Cancelar</button><button @click="saveBanner" class="px-5 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primaryDark">Guardar</button></div>
        </div>
    </div>

    <!-- MODAL ABRIR CAJA -->
    <div v-if="finance.showOpenModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 text-center">Apertura de Caja</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 text-center">Ingresa el monto de efectivo con el que inicias el turno (Fondo).</p>
            
            <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Monto Inicial</label>
            <div class="relative mb-6">
                <span class="absolute left-4 top-3 text-slate-400 font-bold">$</span>
                <input v-model.number="finance.openAmount.value" type="number" class="w-full pl-8 pr-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-900 border-none font-bold text-lg focus:ring-2 focus:ring-primary outline-none dark:text-white text-center">
            </div>

            <div class="flex gap-3">
                <button @click="finance.showOpenModal.value = false" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">Cancelar</button>
                <button @click="finance.openRegister" class="flex-1 bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-600 transition">Abrir Caja</button>
            </div>
        </div>
    </div>

    <!-- MODAL REGISTRAR MOVIMIENTO -->
    <div v-if="finance.showMovementModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in border-t-4" :class="finance.movementForm.type === 'in' ? 'border-green-500' : 'border-red-500'">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2 text-center">
                {{ finance.movementForm.type === 'in' ? 'Ingreso de Efectivo' : 'Retiro de Efectivo' }}
            </h3>
            
            <div class="space-y-4 mt-6">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold">$</span>
                        <input v-model.number="finance.movementForm.amount" type="number" class="w-full pl-8 pr-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-900 border-none font-bold text-lg focus:ring-2 focus:ring-primary outline-none dark:text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-400 mb-2">Motivo / Concepto</label>
                    <textarea v-model="finance.movementForm.reason" rows="2" placeholder="Ej: Compra de hielo, Pago proveedor..." class="w-full p-3 rounded-xl bg-slate-100 dark:bg-slate-900 border-none focus:ring-2 focus:ring-primary outline-none dark:text-white text-sm resize-none"></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="finance.showMovementModal.value = false" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">Cancelar</button>
                <button @click="finance.registerMovement" class="flex-1 text-white font-bold py-3 rounded-xl shadow-lg transition" :class="finance.movementForm.type === 'in' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'">
                    Registrar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL CERRAR CAJA (CORTE) -->
    <div v-if="finance.showCloseModal.value" class="fixed inset-0 z-50 flex items-center justify-center p-3 sm:p-4 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 w-full h-auto max-h-[95vh] sm:max-h-screen max-w-2xl rounded-2xl shadow-2xl animate-fade-in overflow-hidden flex flex-col overflow-y-auto sm:overflow-y-visible">
            <!-- Header -->
            <div class="text-center p-4 sm:p-6 lg:p-8 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-red-50 to-orange-50 dark:from-slate-900 dark:to-slate-800 shrink-0">
                <div class="w-12 sm:w-16 h-12 sm:h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2 sm:mb-4 text-xl sm:text-2xl shadow-sm">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                </div>
                <h3 class="text-lg sm:text-2xl font-bold text-slate-800 dark:text-white">Corte de Caja</h3>
                <p class="text-slate-500 dark:text-slate-400 text-xs sm:text-sm mt-1">Registra los recuentos de cada método de pago e ingresa el total real contado.</p>
            </div>

            <!-- Body -->
            <div class="p-4 sm:p-6 lg:p-8 overflow-y-auto space-y-4 sm:space-y-6 flex-1">
                
                <!-- Información del Turno -->
                <div class="bg-slate-50 dark:bg-slate-900 rounded-xl p-3 sm:p-4 border border-slate-200 dark:border-slate-700 space-y-2">
                    <div class="flex justify-between text-xs sm:text-sm">
                        <span class="text-slate-600 dark:text-slate-400">Efectivo en Sistema:</span>
                        <span class="font-bold text-slate-800 dark:text-white">${{ finance.currentData.value.currentCashInDrawer.toFixed(2) }}</span>
                    </div>
                    <div class="flex justify-between text-xs sm:text-sm">
                        <span class="text-slate-600 dark:text-slate-400">Ventas Totales del Turno:</span>
                        <span class="font-bold text-slate-800 dark:text-white">${{ finance.currentData.value.salesSummary.total.toFixed(2) }}</span>
                    </div>
                </div>

                <!-- Recuento por Método de Pago -->
                <div class="space-y-3 sm:space-y-4">
                    <h4 class="font-bold text-slate-800 dark:text-white uppercase text-xs tracking-wider">Recuento Manual por Método de Pago</h4>
                    
                    <!-- EFECTIVO -->
                    <div class="border border-slate-200 dark:border-slate-700 rounded-xl p-3 sm:p-4 space-y-3 bg-slate-50 dark:bg-slate-900/50">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="flex items-center gap-2 sm:gap-3 w-full">
                                <div class="w-9 sm:w-10 h-9 sm:h-10 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-lg flex items-center justify-center text-sm sm:text-lg shrink-0">
                                    <i class="fa-solid fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-800 dark:text-white text-sm sm:text-base">Efectivo</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Dinero físico contado</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recuento Manual</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-400 font-bold">$</span>
                                    <input v-model.number="finance.closeAmount.value" type="number" step="0.01" placeholder="0.00" class="w-full pl-8 pr-3 py-2 sm:py-2.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 font-bold text-right outline-none focus:ring-2 focus:ring-green-500 dark:text-white text-sm sm:text-base">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Total Esperado</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg bg-slate-200 dark:bg-slate-700 font-bold text-right text-slate-700 dark:text-slate-300 text-xs sm:text-sm">
                                    ${{ finance.currentData.value.currentCashInDrawer.toFixed(2) }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Diferencia</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg font-bold text-right text-xs sm:text-sm"
                                     :class="(finance.closeAmount.value || 0) === finance.currentData.value.currentCashInDrawer 
                                              ? 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400'
                                              : (finance.closeAmount.value || 0) > finance.currentData.value.currentCashInDrawer
                                              ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'
                                              : 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'">
                                    <span v-if="(finance.closeAmount.value || 0) === finance.currentData.value.currentCashInDrawer">-</span>
                                    <span v-else-if="(finance.closeAmount.value || 0) > finance.currentData.value.currentCashInDrawer">
                                        Sobrante: ${{ ((finance.closeAmount.value || 0) - finance.currentData.value.currentCashInDrawer).toFixed(2) }}
                                    </span>
                                    <span v-else>
                                        Faltante: ${{ (finance.currentData.value.currentCashInDrawer - (finance.closeAmount.value || 0)).toFixed(2) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TARJETAS DÉBITO -->
                    <div class="border border-slate-200 dark:border-slate-700 rounded-xl p-3 sm:p-4 space-y-3 bg-slate-50 dark:bg-slate-900/50">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-9 sm:w-10 h-9 sm:h-10 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg flex items-center justify-center text-sm sm:text-lg shrink-0">
                                <i class="fa-solid fa-credit-card"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 dark:text-white text-sm sm:text-base">Tarjeta Débito</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Débito contado</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recuento Manual</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-400 font-bold">$</span>
                                    <input v-model.number="finance.closeRecounts.debit" type="number" step="0.01" placeholder="0.00" class="w-full pl-8 pr-3 py-2 sm:py-2.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 font-bold text-right outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-sm sm:text-base">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Total Esperado</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg bg-slate-200 dark:bg-slate-700 font-bold text-right text-slate-700 dark:text-slate-300 text-xs sm:text-sm">
                                    ${{ (finance.currentData.value.salesSummary?.debit_card || 0).toFixed(2) }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Diferencia</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg font-bold text-right text-xs sm:text-sm"
                                     :class="(finance.closeRecounts.debit || 0) === (finance.currentData.value.salesSummary?.debit_card || 0)
                                              ? 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400'
                                              : (finance.closeRecounts.debit || 0) > (finance.currentData.value.salesSummary?.debit_card || 0)
                                              ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'
                                              : 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'">
                                    <span v-if="(finance.closeRecounts.debit || 0) === (finance.currentData.value.salesSummary?.debit_card || 0)">-</span>
                                    <span v-else-if="(finance.closeRecounts.debit || 0) > (finance.currentData.value.salesSummary?.debit_card || 0)">
                                        Sobrante: ${{ ((finance.closeRecounts.debit || 0) - (finance.currentData.value.salesSummary?.debit_card || 0)).toFixed(2) }}
                                    </span>
                                    <span v-else>
                                        Faltante: ${{ ((finance.currentData.value.salesSummary?.debit_card || 0) - (finance.closeRecounts.debit || 0)).toFixed(2) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TARJETAS CRÉDITO -->
                    <div class="border border-slate-200 dark:border-slate-700 rounded-xl p-3 sm:p-4 space-y-3 bg-slate-50 dark:bg-slate-900/50">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                            <div class="w-9 sm:w-10 h-9 sm:h-10 bg-purple-100 dark:bg-purple-900/30 text-purple-600 rounded-lg flex items-center justify-center text-sm sm:text-lg shrink-0">
                                <i class="fa-regular fa-credit-card"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 dark:text-white text-sm sm:text-base">Tarjeta Crédito</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Crédito contado</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Recuento Manual</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-400 font-bold">$</span>
                                    <input v-model.number="finance.closeRecounts.credit" type="number" step="0.01" placeholder="0.00" class="w-full pl-8 pr-3 py-2 sm:py-2.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 font-bold text-right outline-none focus:ring-2 focus:ring-purple-500 dark:text-white text-sm sm:text-base">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Total Esperado</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg bg-slate-200 dark:bg-slate-700 font-bold text-right text-slate-700 dark:text-slate-300 text-xs sm:text-sm">
                                    ${{ (finance.currentData.value.salesSummary?.credit_card || 0).toFixed(2) }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Diferencia</label>
                                <div class="px-3 py-2 sm:py-2.5 rounded-lg font-bold text-right text-xs sm:text-sm"
                                     :class="(finance.closeRecounts.credit || 0) === (finance.currentData.value.salesSummary?.credit_card || 0)
                                              ? 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400'
                                              : (finance.closeRecounts.credit || 0) > (finance.currentData.value.salesSummary?.credit_card || 0)
                                              ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'
                                              : 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400'">
                                    <span v-if="(finance.closeRecounts.credit || 0) === (finance.currentData.value.salesSummary?.credit_card || 0)">-</span>
                                    <span v-else-if="(finance.closeRecounts.credit || 0) > (finance.currentData.value.salesSummary?.credit_card || 0)">
                                        Sobrante: ${{ ((finance.closeRecounts.credit || 0) - (finance.currentData.value.salesSummary?.credit_card || 0)).toFixed(2) }}
                                    </span>
                                    <span v-else>
                                        Faltante: ${{ ((finance.currentData.value.salesSummary?.credit_card || 0) - (finance.closeRecounts.credit || 0)).toFixed(2) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOTAL REAL SUMADO -->
                <div class="bg-gradient-to-r from-slate-900 to-slate-800 dark:from-slate-950 dark:to-slate-900 rounded-xl p-4 sm:p-6 border border-slate-700">
                    <p class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-2">Monto Total Real (Sumado)</p>
                    <div class="text-2xl sm:text-3xl lg:text-4xl font-black text-white flex items-baseline gap-1 sm:gap-2">
                        <span>$</span>
                        <span>{{ (
                            (finance.closeAmount.value || 0) +
                            (finance.closeRecounts.debit || 0) +
                            (finance.closeRecounts.credit || 0) +
                            (finance.closeRecounts.transfer || 0)
                        ).toFixed(2) }}</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-3 sm:p-4 lg:p-6 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row gap-2 sm:gap-3 shrink-0">
                <button @click="finance.showCloseModal.value = false" class="flex-1 py-2.5 sm:py-3 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl transition text-sm sm:text-base">Cancelar</button>
                <button @click="finance.closeRegister" class="flex-1 bg-slate-900 dark:bg-white dark:text-slate-900 text-white font-bold py-2.5 sm:py-3 rounded-xl shadow-lg hover:opacity-90 transition active:scale-95 text-sm sm:text-base">
                    Finalizar Corte
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL COMPARTIR WHATSAPP -->
    <div v-if="showShareModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-3xl w-full max-w-md shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm">
                    <i class="fa-brands fa-whatsapp"></i>
                </div>
                <h3 class="font-bold text-2xl dark:text-white mb-2">Enviar {{ shareContext === 'quote' ? 'Cotización' : 'Ticket' }}</h3>
                <p class="text-slate-500 dark:text-slate-400">Selecciona el país e ingresa el WhatsApp.</p>
            </div>
            
            <div class="mb-8">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Número Celular</label>
                <div class="flex gap-3">
                    <div class="relative w-32 shrink-0">
                        <select v-model="sharePrefix" class="w-full h-14 pl-3 pr-8 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-100 dark:border-slate-600 dark:text-white font-bold outline-none focus:border-green-500 transition-colors appearance-none cursor-pointer text-lg">
                            <option value="52">🇲🇽 +52</option>
                            <option value="1">🇺🇸 +1</option>
                        </select>
                        <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-slate-400">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <input v-model="sharePhone" type="tel" placeholder="123 456 7890" class="flex-1 h-14 px-4 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-100 dark:border-slate-600 dark:text-white text-lg font-bold outline-none focus:border-green-500 transition-colors placeholder-slate-300">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button @click="showShareModal = false" class="py-4 text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition">Cancelar</button>
                <button @click="confirmShare" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 transition flex items-center justify-center gap-2">
                    <i class="fa-regular fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- NUEVO: MODAL PREVISUALIZACIÓN TICKET -->
    <div v-if="showTicketModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 transition-all" style="z-index: 100;">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-sm shadow-2xl flex flex-col max-h-[90vh]">
            <!-- Header Modal -->
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 rounded-t-3xl">
                <h3 class="font-bold text-lg dark:text-white"><i class="fa-solid fa-print mr-2"></i> Vista Previa Ticket</h3>
                <button @click="showTicketModal = false" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <!-- Cuerpo (El Ticket en sí) -->
            <div class="flex-1 overflow-y-auto p-6 bg-slate-200 dark:bg-slate-950 flex justify-center">
                <!-- Contenedor ID para imprimir -->
                <div id="thermal-ticket-content" class="ticket-preview text-xs leading-tight">
                    <div class="text-center mb-2">
                        <h2 class="text-lg font-bold">{{ settings.appName }}</h2>
                        <p>{{ settings.address }}</p>
                        <p>Tel: {{ settings.phone }}</p>
                        <p class="mt-1">{{ new Date().toLocaleString() }}</p>
                    </div>
                    
                    <div class="ticket-dashed"></div>
                    
                    <div class="flex justify-between font-bold">
                        <span>Folio:</span>
                        <span>#{{ ticketData?.folio }}</span>
                    </div>
                    <div>Cliente: {{ ticketData?.customer }}</div>
                    
                    <div class="ticket-dashed"></div>
                    
                    <div class="font-bold mb-1 flex justify-between">
                        <span>Cant. Prod.</span>
                        <span>Total</span>
                    </div>
                    
                    <div v-for="item in ticketData?.items" :key="item.name" class="flex justify-between mb-1">
                        <span>{{ item.qty }} x {{ item.name }}</span>
                        <span>${{ (item.price * item.qty).toFixed(2) }}</span>
                    </div>

                    <div class="ticket-dashed"></div>

                    <div class="flex justify-between font-bold text-sm">
                        <span>TOTAL</span>
                        <span>${{ ticketData?.total.toFixed(2) }}</span>
                    </div>
                    
                    <div class="ticket-dashed"></div>
                    
                    <div class="text-center mt-2">
                        <p>Método: {{ ticketData?.method }}</p>
                        <p class="mt-2 font-bold">¡Gracias por su compra!</p>
                        <p class="text-[10px] mt-1">Software: Tengo Hambre</p>
                    </div>
                </div>
            </div>

            <!-- Footer Acciones -->
            <div class="p-4 border-t dark:border-slate-700 bg-white dark:bg-slate-800 rounded-b-3xl grid grid-cols-2 gap-4">
                <button @click="showTicketModal = false" class="py-3 text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition">Cerrar</button>
                <button @click="printTicketNow" class="bg-slate-800 dark:bg-white dark:text-slate-900 text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
            
</div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="../assets/js/admin/app.js" type="module" async></script>
</body>
</html>